{% extends "base.html" %} {% block title %}Production Overview - Quality
Operational Dashboard{% endblock %} {% block additional_head %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<style>
  body {
    overflow-x: hidden;
  }
  .dashboard-container {
    display: flex;
    flex-direction: column;
    width: 100%;
  }
  .tab-container {
    display: flex;
    border-bottom: 1px solid #e5e7eb;
    margin-bottom: 1rem;
    overflow-x: auto;
    scrollbar-width: thin;
  }
  .tab {
    padding: 0.75rem 1.5rem;
    font-weight: 500;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    white-space: nowrap;
  }
  .tab.active {
    border-bottom-color: #3b82f6;
    color: #3b82f6;
  }
  .tab-content {
    display: none;
  }
  .tab-content.active {
    display: block;
  }
  .chart-container {
    height: 320px;
    width: 100%;
    margin: 0 auto;
  }
  .chart-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1rem;
    margin-bottom: 1rem;
  }
  .chart-card {
    background-color: white;
    border-radius: 0.5rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    padding: 1rem;
    display: flex;
    flex-direction: column;
  }
  .chart-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
  }
  .chart-card-title {
    font-size: 1rem;
    font-weight: 600;
    color: #374151;
  }
  .chart-card-actions {
    display: flex;
    gap: 0.5rem;
  }
  .chart-card-body {
    flex: 1;
    min-height: 300px;
    position: relative;
  }
  .loading-indicator {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(255, 255, 255, 0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10;
  }
  .spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid #3b82f6;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  @keyframes spin {
    0% {
      transform: rotate(0deg);
    }
    100% {
      transform: rotate(360deg);
    }
  }
  /* Update the CSS for filter controls to make them more compact */
  .filter-container {
    background-color: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 0.375rem;
    padding: 0.75rem;
    margin-bottom: 1rem;
  }

  /* Improve filter group alignment */
  .filter-group {
    display: flex;
    gap: 0.5rem;
    align-items: flex-end; /* Align items at the bottom */
    flex-wrap: nowrap;
  }

  .filter-item {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    flex: 0 0 auto;
  }

  .filter-label {
    font-size: 0.75rem;
    font-weight: 500;
    color: #4b5563;
  }

  .filter-input {
    padding: 0.375rem 0.5rem;
    border: 1px solid #d1d5db;
    border-radius: 0.375rem;
    font-size: 0.75rem;
    min-width: 120px;
    max-width: 150px;
  }

  /* Update the CSS for filter buttons to make them look more like buttons */
  .filter-button {
    padding: 0.375rem 0.75rem;
    border-radius: 0.375rem;
    font-size: 0.75rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 70px;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    border: 1px solid transparent;
  }

  .filter-button-primary {
    background-color: #3b82f6;
    color: white;
    border-color: #2563eb;
  }

  .filter-button-primary:hover {
    background-color: #2563eb;
    border-color: #1d4ed8;
  }

  .filter-button-secondary {
    background-color: #9ca3af;
    color: white;
    border-color: #6b7280;
  }

  .filter-button-secondary:hover {
    background-color: #6b7280;
    border-color: #4b5563;
  }

  .table-container {
    overflow-x: auto;
    max-width: 100%;
    background-color: white;
    border-radius: 0.5rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }
  .sticky-header th {
    position: sticky;
    top: 0;
    background-color: #f9fafb;
    z-index: 10;
  }
  .sortable-header {
    cursor: pointer;
    user-select: none;
    position: relative;
    padding-right: 1.5rem !important;
  }
  .sortable-header:hover {
    background-color: #f3f4f6;
  }
  .sort-indicator {
    position: absolute;
    right: 0.5rem;
    top: 50%;
    transform: translateY(-50%);
    display: inline-block;
    width: 0.75rem;
    height: 0.75rem;
    opacity: 0.5;
  }
  .sort-indicator.active {
    opacity: 1;
  }
  .sort-asc::after {
    content: "▲";
    font-size: 0.75rem;
  }
  .sort-desc::after {
    content: "▼";
    font-size: 0.75rem;
  }
  .pagination-controls {
    background-color: #f9fafb;
    border: 1px solid #e5e7eb;
    padding: 0.75rem;
    border-radius: 0.375rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 0.5rem;
  }
  .pagination-controls select,
  .pagination-controls input {
    border: 1px solid #d1d5db;
    border-radius: 0.25rem;
    padding: 0.25rem 0.5rem;
  }
  .pagination-controls button {
    transition: all 0.2s;
    padding: 0.25rem 0.75rem;
    border-radius: 0.25rem;
  }
  .pagination-controls button:not(:disabled):hover {
    background-color: #e5e7eb;
  }
  .pagination-controls button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  .axis-select {
    padding: 0.5rem;
    border: 1px solid #d1d5db;
    border-radius: 0.375rem;
    font-size: 0.875rem;
    background-color: white;
    min-width: 150px;
  }
  /* Make visualization controls more compact */
  .visualization-controls {
    display: flex;
    flex-wrap: nowrap;
    gap: 0.5rem;
    margin-bottom: 1rem;
    overflow-x: auto;
    padding-bottom: 0.5rem;
    align-items: flex-end; /* Align items at the bottom */
  }

  .control-group {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    flex: 0 0 auto;
  }

  .control-label {
    font-size: 0.75rem;
    font-weight: 500;
    color: #4b5563;
  }

  .axis-select {
    padding: 0.375rem 0.5rem;
    border: 1px solid #d1d5db;
    border-radius: 0.375rem;
    font-size: 0.75rem;
    background-color: white;
    min-width: 120px;
    max-width: 150px;
    height: 28px; /* Match the height of filter-input */
  }
  .visualization-controls {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    margin-bottom: 1rem;
  }
  .control-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }
  .control-label {
    font-size: 0.875rem;
    font-weight: 500;
    color: #4b5563;
  }
  .data-card {
    background-color: white;
    border-radius: 0.5rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
  }
  .data-card-value {
    font-size: 2rem;
    font-weight: 700;
    color: #3b82f6;
    margin: 0.5rem 0;
  }
  .data-card-label {
    font-size: 0.875rem;
    color: #6b7280;
  }
  .data-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 1rem;
  }
  .toggle-button {
    background: none;
    border: none;
    color: #6b7280;
    cursor: pointer;
    padding: 0.25rem;
    border-radius: 0.25rem;
    transition: all 0.2s;
  }
  .toggle-button:hover {
    background-color: #f3f4f6;
    color: #374151;
  }
  .toggle-button svg {
    width: 1.25rem;
    height: 1.25rem;
  }
  .expand-icon,
  .collapse-icon {
    display: inline-block;
    width: 1.25rem;
    height: 1.25rem;
  }
  .expand-icon::before {
    content: "⤢";
  }
  .collapse-icon::before {
    content: "⤡";
  }
  .expanded-chart {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(255, 255, 255, 0.95);
    z-index: 50;
    padding: 2rem;
    display: flex;
    flex-direction: column;
  }
  .expanded-chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
  }
  .expanded-chart-title {
    font-size: 1.5rem;
    font-weight: 600;
  }
  .expanded-chart-body {
    flex: 1;
    min-height: 0;
  }
  .expanded-chart .chart-container {
    height: 100%;
    width: 100%;
  }
  .close-button {
    background: none;
    border: none;
    color: #6b7280;
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 0.375rem;
    transition: all 0.2s;
    font-size: 1.5rem;
    line-height: 1;
  }
  .close-button:hover {
    background-color: #f3f4f6;
    color: #374151;
  }
  .badge {
    display: inline-flex;
    align-items: center;
    padding: 0.25rem 0.5rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 500;
  }
  .badge-success {
    background-color: #d1fae5;
    color: #065f46;
  }
  .badge-warning {
    background-color: #fef3c7;
    color: #92400e;
  }
  .badge-danger {
    background-color: #fee2e2;
    color: #b91c1c;
  }
  .badge-info {
    background-color: #e0f2fe;
    color: #0369a1;
  }
  .tooltip {
    position: relative;
    display: inline-block;
  }
  .tooltip .tooltip-text {
    visibility: hidden;
    width: 200px;
    background-color: #374151;
    color: white;
    text-align: center;
    border-radius: 6px;
    padding: 0.5rem;
    position: absolute;
    z-index: 1;
    bottom: 125%;
    left: 50%;
    transform: translateX(-50%);
    opacity: 0;
    transition: opacity 0.3s;
    font-size: 0.75rem;
  }
  .tooltip:hover .tooltip-text {
    visibility: visible;
    opacity: 1;
  }

  /* Add these styles to the existing <style> section */
  .js-plotly-plot .plotly .modebar {
    position: absolute !important;
    top: 5px !important;
    right: 10px !important;
    z-index: 1000 !important;
  }

  .js-plotly-plot .plotly .modebar-horizontal {
    display: flex !important;
    flex-direction: row !important;
    background-color: rgba(255, 255, 255, 0.7) !important;
    border-radius: 4px !important;
    padding: 2px !important;
  }

  .js-plotly-plot .plotly .modebar-btn {
    margin: 2px !important;
    padding: 2px !important;
  }

  .js-plotly-plot .plotly .modebar-group {
    display: flex !important;
    flex-direction: row !important;
    margin-right: 0 !important;
    margin-left: 0 !important;
    padding: 0 !important;
  }

  /* Ensure chart containers have proper padding for modebar */
  .chart-card-body {
    position: relative !important;
    padding-top: 40px !important;
    overflow: visible !important;
  }

  /* Fix for right side overflow */
  .chart-container {
    width: 100% !important;
    overflow: hidden !important;
    position: relative !important;
  }

  /* Ensure axis labels don't overflow */
  .js-plotly-plot .plotly .xtitle,
  .js-plotly-plot .plotly .ytitle {
    font-size: 12px !important;
  }

  /* Add padding to chart containers to prevent overflow */
  .chart-container {
    padding: 5px;
  }

  /* Add these styles to the <style> section */

  .js-plotly-plot {
    overflow: visible !important;
  }

  /* Fix chart container to prevent overflow */
  .chart-container {
    width: 100% !important;
    overflow: hidden !important;
    position: relative !important;
    box-sizing: border-box !important;
    padding-right: 10px !important;
  }

  /* Ensure the Plotly chart doesn't overflow */
  .js-plotly-plot {
    width: 100% !important;
    max-width: 100% !important;
    overflow: hidden !important;
  }

  /* Fix the modebar positioning */
  .js-plotly-plot .plotly .modebar {
    position: absolute !important;
    top: 5px !important;
    right: 10px !important;
    z-index: 1000 !important;
    background-color: rgba(255, 255, 255, 0.7) !important;
    border-radius: 4px !important;
  }

  /* Ensure the chart body has enough padding for the modebar */
  .chart-card-body {
    position: relative !important;
    padding-top: 40px !important;
    padding-right: 10px !important;
    overflow: hidden !important;
  }

  /* Update the axis-select to match filter-input styling */
  .axis-select {
    padding: 0.375rem 0.5rem;
    border: 1px solid #d1d5db;
    border-radius: 0.375rem;
    font-size: 0.75rem;
    background-color: white;
    min-width: 120px;
    max-width: 150px;
    height: 28px; /* Match the height of filter-input */
  }

  /* Make filter inputs consistent height */
  .filter-input {
    padding: 0.375rem 0.5rem;
    border: 1px solid #d1d5db;
    border-radius: 0.375rem;
    font-size: 0.75rem;
    min-width: 120px;
    max-width: 150px;
    height: 28px; /* Consistent height */
  }

  /* Add notification styles */
  .notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 12px 20px;
    background-color: #3b82f6;
    color: white;
    border-radius: 4px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    z-index: 1000;
    max-width: 300px;
    opacity: 0;
    transform: translateY(-20px);
    transition: opacity 0.3s, transform 0.3s;
  }

  .notification.show {
    opacity: 1;
    transform: translateY(0);
  }

  .notification.info {
    background-color: #3b82f6;
  }

  .notification.warning {
    background-color: #f59e0b;
  }

  .notification.error {
    background-color: #ef4444;
  }

  .notification.success {
    background-color: #10b981;
  }

  /* Enhanced table header styles for integrated search */
  .table-header-cell {
    position: relative;
    vertical-align: top;
    padding: 0.75rem;
    background-color: #f9fafb;
    border-bottom: 2px solid #e5e7eb;
    min-width: 120px;
  }

  .header-content {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    height: 70px; /* Fixed height for consistency */
    justify-content: space-between;
  }

  .header-title {
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: #374151;
    cursor: pointer;
    user-select: none;
    padding: 0.25rem 0.5rem;
    position: relative;
    min-height: 24px;
    max-height: 24px;
    border-radius: 0.25rem;
    transition: background-color 0.2s;
  }

  .header-title:hover {
    background-color: #f3f4f6;
  }

  .header-search-container {
    position: relative;
    height: 32px; /* Fixed height for search container */
    display: flex;
    align-items: center;
  }

  .header-search {
    width: 100%;
    height: 28px; /* Fixed height for all search inputs */
    padding: 0.25rem 0.5rem;
    border: 1px solid #d1d5db;
    border-radius: 0.25rem;
    font-size: 0.75rem;
    background-color: white;
    transition: border-color 0.2s, box-shadow 0.2s;
    box-sizing: border-box;
  }

  .header-search:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 1px #3b82f6;
  }

  .header-search::placeholder {
    color: #9ca3af;
    font-size: 0.7rem;
  }

  /* Sort indicator positioning for new layout */
  .sort-indicator {
    position: absolute;
    right: 0.25rem;
    top: 50%;
    transform: translateY(-50%);
    display: inline-block;
    width: 0.75rem;
    height: 0.75rem;
    opacity: 0.5;
    pointer-events: none;
  }

  .sort-indicator.active {
    opacity: 1;
  }

  /* Clear search button */
  .clear-search {
    position: absolute;
    right: 0.25rem;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: #9ca3af;
    cursor: pointer;
    font-size: 0.75rem;
    padding: 0.125rem;
    border-radius: 0.125rem;
    opacity: 0;
    transition: opacity 0.2s;
    width: 16px;
    height: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .header-search:not(:placeholder-shown) + .clear-search {
    opacity: 1;
  }

  .clear-search:hover {
    color: #6b7280;
    background-color: #f3f4f6;
  }

  /* Responsive table adjustments */
  @media (max-width: 768px) {
    .header-content {
      height: 60px;
      gap: 0.25rem;
    }
    
    .header-title {
      font-size: 0.7rem;
      min-height: 20px;
      max-height: 20px;
    }
    
    .header-search-container {
      height: 28px;
    }
    
    .header-search {
      height: 24px;
      font-size: 0.7rem;
      padding: 0.2rem 0.4rem;
    }
  }

  /* Table search toggle styles */
  .table-search-toggle {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .search-toggle-switch {
    position: relative;
    display: inline-block;
    width: 44px;
    height: 24px;
  }

  .search-toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }

  .search-toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: 0.3s;
    border-radius: 24px;
  }

  .search-toggle-slider:before {
    position: absolute;
    content: "";
    height: 18px;
    width: 18px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: 0.3s;
    border-radius: 50%;
  }

  input:checked + .search-toggle-slider {
    background-color: #3b82f6;
  }

  input:checked + .search-toggle-slider:before {
    transform: translateX(20px);
  }
</style>
{% endblock %} {% block content %}
<h1 class="text-3xl font-bold text-gray-800 mb-4">Production Overview</h1>

<div class="dashboard-container">
  <!-- Dashboard Tabs -->
  <div class="tab-container">
    <div class="tab active" data-tab="summary">Summary</div>
    <div class="tab" data-tab="production-analysis">Production Analysis</div>
    <div class="tab" data-tab="3d-visualization">3D Visualization</div>
    <div class="tab" data-tab="data-table">Data Table</div>
  </div>

  <!-- Summary Tab -->
  <div class="tab-content active" id="summary-tab">
    <!-- Summary Cards -->
    <div class="data-grid">
      <div class="data-card">
        <div class="data-card-label">Total Coils</div>
        <div class="data-card-value" id="total-coils">-</div>
        <div class="data-card-label">Production Units</div>
      </div>
      <div class="data-card">
        <div class="data-card-label">Average Thickness</div>
        <div class="data-card-value" id="avg-thickness">-</div>
        <div class="data-card-label">mm</div>
      </div>
      <div class="data-card">
        <div class="data-card-label">Average Width</div>
        <div class="data-card-value" id="avg-width">-</div>
        <div class="data-card-label">mm</div>
      </div>
      <div class="data-card">
        <div class="data-card-label">Approval Rate</div>
        <div class="data-card-value" id="approval-rate">-</div>
        <div class="data-card-label">% Approved</div>
      </div>
    </div>

    <!-- Summary Charts -->
    <div class="chart-grid">
      <div class="chart-card">
        <div class="chart-card-header">
          <div class="chart-card-title">Daily Coil Production</div>
          <div class="chart-card-actions">
            <button class="toggle-button refresh-chart" data-chart="daily-coil">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                />
              </svg>
            </button>
            <button class="toggle-button expand-chart" data-chart="daily-coil">
              <span class="expand-icon"></span>
            </button>
          </div>
        </div>
        <div class="chart-card-body">
          <div class="loading-indicator" id="daily-coil-loading">
            <div class="spinner"></div>
          </div>
          <div class="chart-container" id="daily-coil-chart"></div>
        </div>
      </div>
      <div class="chart-card">
        <div class="chart-card-header">
          <div class="chart-card-title">Coil Product Distribution</div>
          <div class="chart-card-actions">
            <button
              class="toggle-button refresh-chart"
              data-chart="coil-distribution"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                />
              </svg>
            </button>
            <button
              class="toggle-button expand-chart"
              data-chart="coil-distribution"
            >
              <span class="expand-icon"></span>
            </button>
          </div>
        </div>
        <div class="chart-card-body">
          <div class="loading-indicator" id="coil-distribution-loading">
            <div class="spinner"></div>
          </div>
          <div class="chart-container" id="coil-distribution-chart"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Production Analysis Tab -->
  <div class="tab-content" id="production-analysis-tab">
    <!-- Filter Controls -->
    <div class="filter-container">
      <div class="filter-group">
        <div class="filter-item">
          <label class="filter-label">From Date</label>
          <input
            type="date"
            id="analysis-from-date"
            class="filter-input"
            placeholder="Select date"
          />
        </div>
        <div class="filter-item">
          <label class="filter-label">To Date</label>
          <input
            type="date"
            id="analysis-to-date"
            class="filter-input"
            placeholder="Select date"
          />
        </div>
        <div class="filter-item">
          <label class="filter-label">Product</label>
          <select id="analysis-product" class="filter-input">
            <option value="">All Products</option>
            <!-- Products will be populated dynamically -->
          </select>
        </div>
        <div class="filter-item">
          <button
            id="apply-analysis-filters"
            class="filter-button filter-button-primary"
          >
            Apply
          </select>
        </div>
        <div class="filter-item">
          <button
            id="reset-analysis-filters"
            class="filter-button filter-button-secondary"
          >
            Reset
          </button>
        </div>
        <div class="filter-item">
          <button
            id="export-analysis-data"
            class="filter-button filter-button-secondary"
          >
            Export
          </button>
        </div>
      </div>
    </div>

    <!-- Analysis Charts -->
    <div class="chart-card mb-6">
      <div class="chart-card-header">
        <div class="chart-card-title">Coil Production Analysis</div>
        <div class="chart-card-actions">
          <button
            class="toggle-button refresh-chart"
            data-chart="coil-analysis"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
              />
            </svg>
          </button>
          <button class="toggle-button expand-chart" data-chart="coil-analysis">
            <span class="expand-icon"></span>
          </button>
        </div>
      </div>
      <div class="chart-card-body" style="height: 500px">
        <div
          class="loading-indicator"
          id="coil-analysis-loading"
          style="display: none"
        >
          <div class="spinner"></div>
        </div>
        <div
          class="chart-container"
          id="coil-analysis-chart"
          style="height: 100%"
        >
          <div
            class="flex h-full items-center justify-center text-gray-500"
            id="analysis-default-message"
          >
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 3D Visualization Tab -->
  <div class="tab-content" id="3d-visualization-tab">
    <!-- Update the 3D Visualization Tab filter controls to be more compact -->
    <div class="filter-container">
      <div class="visualization-controls">
        <div class="filter-item">
          <label class="filter-label">From Date</label>
          <input
            type="date"
            id="viz-from-date"
            class="filter-input"
            placeholder="Select date"
          />
        </div>
        <div class="filter-item">
          <label class="filter-label">To Date</label>
          <input
            type="date"
            id="viz-to-date"
            class="filter-input"
            placeholder="Select date"
          />
        </div>
        <div class="filter-item">
          <label class="filter-label">Product</label>
          <select id="viz-product-filter" class="filter-input">
            <option value="">All Products</option>
            <!-- Products will be populated dynamically -->
          </select>
        </div>
        <div class="control-group">
          <label class="control-label" for="x-axis">X-Axis</label>
          <select id="x-axis" class="axis-select">
            <option value="finalThk">Final Thickness (mm)</option>
            <option value="planThickness">Planned Thickness (mm)</option>
            <option value="finalWidth">Final Width (mm)</option>
            <option value="planWidth">Planned Width (mm)</option>
            <option value="finalWeight">Final Weight (kg)</option>
            <option value="yieldStrength">Yield Strength (MPa)</option>
            <option value="elongation">Elongation (%)</option>
            <option value="hardness">Hardness (HV)</option>
            <option value="age">Age (days)</option>
          </select>
        </div>

        <div class="control-group">
          <label class="control-label" for="y-axis">Y-Axis</label>
          <select id="y-axis" class="axis-select">
            <option value="finalWidth">Final Width (mm)</option>
            <option value="finalThk">Final Thickness (mm)</option>
            <option value="planThickness">Planned Thickness (mm)</option>
            <option value="planWidth">Planned Width (mm)</option>
            <option value="finalWeight">Final Weight (kg)</option>
            <option value="yieldStrength">Yield Strength (MPa)</option>
            <option value="elongation">Elongation (%)</option>
            <option value="hardness">Hardness (HV)</option>
            <option value="age">Age (days)</option>
          </select>
        </div>

        <div class="control-group">
          <label class="control-label" for="z-axis">Z-Axis</label>
          <select id="z-axis" class="axis-select">
            <option value="finalWeight">Final Weight (kg)</option>
            <option value="finalThk">Final Thickness (mm)</option>
            <option value="planThickness">Planned Thickness (mm)</option>
            <option value="finalWidth">Final Width (mm)</option>
            <option value="planWidth">Planned Width (mm)</option>
            <option value="yieldStrength">Yield Strength (MPa)</option>
            <option value="elongation">Elongation (%)</option>
            <option value="hardness">Hardness (HV)</option>
            <option value="age">Age (days)</option>
          </select>
        </div>

        <div class="control-group">
          <label class="control-label" for="color-by">Color By</label>
          <select id="color-by" class="axis-select">
            <option value="product">Product</option>
            <option value="finalStatus">Final Status</option>
            <option value="material">Material</option>
            <option value="shift">Shift</option>
            <option value="planned_vs_final_thickness">
              Planned vs Final Thickness
            </option>
            <option value="planned_vs_final_width">
              Planned vs Final Width
            </option>
          </select>
        </div>

        <div class="control-group">
          <label class="control-label" for="visualization-type">Type</label>
          <select id="visualization-type" class="axis-select">
            <option value="scatter">3D Scatter</option>
            <option value="surface">3D Surface</option>
            <option value="mesh">3D Mesh</option>
          </select>
        </div>

        <div class="control-group">
          <button
            id="update-3d-visualization"
            class="filter-button filter-button-primary"
          >
            Update
          </button>
        </div>

        <div class="control-group">
          <button
            id="export-3d-visualization"
            class="filter-button filter-button-secondary"
          >
            Export
          </button>
        </div>
      </div>
    </div>

    <div class="chart-card">
      <div class="chart-card-header">
        <div class="chart-card-title">3D Parameter Visualization</div>
        <div class="chart-card-actions">
          <div class="tooltip">
            <button class="toggle-button" id="3d-help">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                />
              </svg>
            </button>
            <span class="tooltip-text"
              >The visualization shows all available data points by default. Use
              the filters to limit the data. The "Planned vs Final" color
              options show variance between planned and actual values - green
              indicates values close to plan, red indicates larger
              deviations.</span
            >
          </div>
          <button
            class="toggle-button expand-chart"
            data-chart="3d-visualization"
          >
            <span class="expand-icon"></span>
          </button>
        </div>
      </div>
      <div class="chart-card-body" style="height: 600px">
        <div class="loading-indicator" id="visualization-3d-loading">
          <div class="spinner"></div>
        </div>
        <div class="chart-container" id="visualization-3d" style="height: 100%">
          <div class="flex h-full items-center justify-center text-gray-500">
            Click "Update Visualization" to generate the 3D view.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Data Table Tab -->
  <div class="tab-content" id="data-table-tab">
    <!-- Table Filters -->
    <div class="filter-container">
      <div class="filter-group">
        
        <div class="filter-item">
          <label class="filter-label">From Date</label>
          <input
            type="date"
            id="table-from-date"
            class="filter-input"
            placeholder="Select date"
          />
        </div>
        <div class="filter-item">
          <label class="filter-label">To Date</label>
          <input
            type="date"
            id="table-to-date"
            class="filter-input"
            placeholder="Select date"
          />
        </div>
        <div class="filter-item">
          <label class="filter-label">Product</label>
          <select id="table-product" class="filter-input">
            <option value="">All Products</option>
            <!-- Products will be populated dynamically -->
          </select>
        </div>
        <div class="filter-item">
          <label class="filter-label">Status</label>
          <select id="table-status" class="filter-input">
            <option value="">All Statuses</option>
            <option value="Approved">Approved</option>
            <option value="Rejected">Rejected</option>
            <option value="Pending">Pending</option>
          </select>
        </div>
        <div class="filter-item">
          <button
            id="apply-table-filters"
            class="filter-button filter-button-primary"
          >
            Apply
          </button>
        </div>
        <div class="filter-item">
          <button
            id="reset-table-filters"
            class="filter-button filter-button-secondary"
          >
            Reset
          </button>
        </div>
        <div class="filter-item">
          <button
            id="export-table-data"
            class="filter-button filter-button-secondary"
          >
            Export
          </button>
        </div>
        <div class="filter-item">
          <label class="filter-label">Column Search</label>
          <div class="table-search-toggle">
            <label class="search-toggle-switch">
              <input type="checkbox" id="enable-table-search">
              <span class="search-toggle-slider"></span>
            </label>
          </div>
        </div>
      </div>
    </div>

    <!-- Column Selector -->
    <div class="filter-container mb-4">
      <div class="flex justify-between items-center">
        <div class="font-medium text-gray-700">Table Columns</div>
        <div class="relative">
          <button
            id="column-selector-btn"
            class="filter-button filter-button-secondary flex items-center gap-2"
          >
            <span>Show/Hide Columns</span>
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="m6 9 6 6 6-6" />
            </svg>
          </button>
          <div
            id="column-dropdown"
            class="absolute right-0 mt-2 bg-white border border-gray-200 rounded-md shadow-lg z-20 p-3 hidden"
            style="width: 280px; max-height: 400px; overflow-y: auto"
          >
            <div
              class="flex justify-between mb-2 pb-2 border-b border-gray-200"
            >
              <button
                id="select-all-columns"
                class="text-sm text-blue-600 hover:text-blue-800"
              >
                Select All
              </button>
              <button
                id="deselect-all-columns"
                class="text-sm text-blue-600 hover:text-blue-800"
              >
                Deselect All
              </button>
            </div>
            <div id="column-toggles" class="grid grid-cols-1 gap-1">
              <!-- Column toggles will be populated dynamically -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Data Table -->
    <div class="table-container mb-4">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50 sticky-header">
          <tr id="table-header">
            <!-- Table headers will be populated dynamically -->
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200" id="table-body">
          <!-- Table rows will be populated dynamically -->
          <tr>
            <td colspan="100%" class="px-3 py-4 text-center text-gray-500">
              Loading data...
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Pagination controls -->
    <div class="pagination-controls mb-6">
      <div class="flex items-center space-x-2">
        <span class="text-sm text-gray-600">Show</span>
        <select id="items-per-page" class="text-sm border rounded p-1">
          <option value="10" selected>10</option>
          <option value="25">25</option>
          <option value="50">50</option>
          <option value="100">100</option>
        </select>
        <span class="text-sm text-gray-600">entries</span>
      </div>
      <div class="text-sm text-gray-600" id="pagination-info">
        Showing 0 to 0 of 0 entries
      </div>
      <div class="flex space-x-2">
        <button
          id="prev-page"
          class="px-3 py-1 bg-gray-200 text-gray-700 rounded disabled:opacity-50 disabled:cursor-not-allowed"
        >
          Previous
        </button>
        <div class="flex items-center px-3 py-1 bg-white border rounded">
          <span class="text-sm">Page</span>
          <input
            type="number"
            id="current-page"
            class="w-12 text-center mx-2 border-0 focus:outline-none"
            value="1"
            min="1"
          />
          <span class="text-sm">of <span id="total-pages">1</span></span>
        </div>
        <button
          id="next-page"
          class="px-3 py-1 bg-gray-200 text-gray-700 rounded disabled:opacity-50 disabled:cursor-not-allowed"
        >
          Next
        </button>
      </div>
    </div>
  </div>
  <!-- Notification container -->
  <div id="notification" class="notification" style="display: none"></div>
</div>

<!-- Expanded Chart Modal -->
<div id="expanded-chart-modal" style="display: none" class="expanded-chart">
  <div class="expanded-chart-header">
    <div class="expanded-chart-title" id="expanded-chart-title">
      Chart Title
    </div>
    <button class="close-button" id="close-expanded-chart">×</button>
  </div>
  <div class="expanded-chart-body">
    <div class="chart-container" id="expanded-chart-container"></div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  $(document).ready(function () {
    // Update the tab switching function to not auto-load 3D visualization
    // Tab switching
    $(".tab").on("click", function () {
      const tabId = $(this).data("tab");

      // Update active tab
      $(".tab").removeClass("active");
      $(this).addClass("active");

      // Show corresponding content
      $(".tab-content").removeClass("active");
      $(`#${tabId}-tab`).addClass("active");

      // Load data for the selected tab
      if (tabId === "summary") {
        loadSummaryData();
      } else if (tabId === "production-analysis") {
        // Set default date range for production analysis tab (Nov 30 - Jan 1, 2024)
        if (!$("#analysis-from-date").val()) {
          $("#analysis-from-date").val("2023-11-30");
        }
        if (!$("#analysis-to-date").val()) {
          $("#analysis-to-date").val("2024-01-01");
        }
        
        // Automatically load analysis data when tab is selected
        loadAnalysisData();
      } else if (tabId === "3d-visualization") {
        // Set default date range for 3D visualization tab (Nov 30 - Dec 31, 2023)
        if (!$("#viz-from-date").val()) {
          $("#viz-from-date").val("2023-11-30");
        }
        if (!$("#viz-to-date").val()) {
          $("#viz-to-date").val("2024-01-01");
        }

        // Automatically load 3D visualization when tab is selected
        $("#visualization-3d").html(
          '<div class="flex h-full items-center justify-center text-gray-500">Loading 3D visualization...</div>'
        );
        update3DVisualization();
      } else if (tabId === "data-table") {
        // Set default date range for data table tab (Nov 30 - Dec 31, 2023)
        if (!$("#table-from-date").val()) {
          $("#table-from-date").val("2023-11-30");
        }
        if (!$("#table-to-date").val()) {
          $("#table-to-date").val("2024-01-01");
        }

        initializeDataTable();
      }
    });

    // Pagination variables
    let currentPage = 1;
    let itemsPerPage = 10;
    let totalPages = 1;
    let paginatedData = [];
    let tableData = [];
    let allColumns = [];
    let visibleColumns = [];
    let productOptions = [];
    let statusOptions = [];

    // Global variables for sorting
    let currentSortParam = "slNo";
    let currentSortDirection = "asc";
    let sortingApplied = false;
    let sortClickCount = {}; // Track clicks per column for 3-state sorting

    // Global variable for table search state
    let tableSearchEnabled = false;

    // Cache for summary data
    let summaryDataCache = null;
    let summaryChartsLoaded = false;

    // Initialize the dashboard
    initializeDashboard();

    function initializeDashboard() {
      // Load initial summary data
      loadSummaryData();

      // Fetch product and status options for filters
      fetchFilterOptions();

      // Set up event handlers
      setupEventHandlers();

      // Set up date range validation
      setupDateRangeValidation();
    }

    function loadSummaryData() {
      // Show loading indicators
      $("#daily-coil-loading, #coil-distribution-loading").show();

      // Load summary metrics
      $.ajax({
        url: "/production_overview/summary_metrics",
        method: "GET",
        success: function (response) {
          // Cache the response
          summaryDataCache = response;
          updateSummaryCards(response);
        },
        error: function (xhr, status, error) {
          console.error("Error loading summary metrics:", error);
        },
      });

      // Always reload charts to ensure they're properly displayed
      loadChart("daily-coil", "/production_overview/daily_production_chart");
      loadChart(
        "coil-distribution",
        "/production_overview/coil_distribution_chart",
        {},
        function () {
          summaryChartsLoaded = true;
        }
      );
    }

    function updateSummaryCards(data) {
      $("#total-coils").text(data.totalCoils || "-");
      $("#avg-thickness").text(
        data.avgThickness ? data.avgThickness.toFixed(2) : "-"
      );
      $("#avg-width").text(data.avgWidth ? data.avgWidth.toFixed(0) : "-");
      $("#approval-rate").text(
        data.approvalRate ? data.approvalRate.toFixed(1) + "%" : "-"
      );
    }

    // Modify the loadChart function to handle callback for error cases too
    function loadChart(chartId, endpoint, params = {}, callback) {
      $(`#${chartId}-loading`).show();
      setControlsDisabled(true);

      $.ajax({
        url: endpoint,
        method: "GET",
        data: params,
        success: function (response) {
          // Clear any previous chart
          $(`#${chartId}-chart`).empty();

          if (chartId === "daily-coil") {
            renderDailyCoilChart(response, chartId);
          } else if (chartId === "coil-distribution") {
            renderCoilDistributionChart(response, chartId);
          } else if (chartId === "coil-analysis") {
            renderCoilAnalysisChart(response, chartId);
          }

          $(`#${chartId}-loading`).hide();
          setControlsDisabled(false);

          if (typeof callback === "function") {
            callback();
          }
        },
        error: function (xhr, status, error) {
          console.error(`Error loading ${chartId} chart:`, error);
          $(`#${chartId}-loading`).hide();
          $(`#${chartId}-chart`).html(
            `<div class="flex h-full items-center justify-center text-gray-500">Error loading chart. Please try again.</div>`
          );
          setControlsDisabled(false);

          if (typeof callback === "function") {
            callback(error);
          }
        },
      });
    }

    // Add new functions to render charts with Plotly
    function renderDailyCoilChart(data, chartId) {
      if (!data.labels || data.labels.length === 0) {
        $(`#${chartId}-chart`).html(
          '<div class="flex h-full items-center justify-center text-gray-500">No daily production data available</div>'
        );
        return;
      }

      const trace = {
        x: data.labels,
        y: data.data,
        type: "bar",
        marker: {
          color: "rgb(55, 83, 109)",
        },
        text: data.data,
        textposition: "auto",
        hovertemplate: "Number of Coils: %{y}<extra></extra>",
      };

      const layout = {
        title: "Daily Coil Production",
        xaxis: {
          title: {
            text: "Date",
            standoff: 15,
          },
          tickangle: 45,
        },
        yaxis: {
          title: "Number of Coils",
          automargin: true,
        },
        plot_bgcolor: "rgba(242, 244, 247, 1)",
        paper_bgcolor: "white",
        height: 300,
        margin: { l: 50, r: 30, t: 40, b: 60 },
        modebar: {
          orientation: "h",
          bgcolor: "rgba(255,255,255,0.7)",
          position: "top-right",
        },
      };

      Plotly.newPlot(`${chartId}-chart`, [trace], layout, {
        displayModeBar: true,
        displaylogo: false,
        responsive: true,
        modeBarButtonsToRemove: [
          "lasso2d",
          "select2d",
          "zoomIn2d",
          "zoomOut2d",
          "autoScale2d",
        ],
      });
    }

    function renderCoilDistributionChart(data, chartId) {
      if (!data.labels || data.labels.length === 0) {
        $(`#${chartId}-chart`).html(
          '<div class="flex h-full items-center justify-center text-gray-500">No coil product data available</div>'
        );
        return;
      }

      // Define a colorful palette
      const colors = [
        "rgb(82, 113, 255)", // Blue
        "rgb(255, 99, 71)", // Coral
        "rgb(34, 197, 94)", // Green
        "rgb(168, 85, 247)", // Purple
        "rgb(251, 146, 60)", // Orange
        "rgb(236, 72, 153)", // Pink
        "rgb(234, 179, 8)", // Yellow
      ];

      const trace = {
        labels: data.labels,
        values: data.data,
        type: "pie",
        hole: 0.4,
        marker: {
          colors: colors,
        },
        textinfo: "label+percent",
        hovertemplate:
          "<b>%{label}</b><br>Count: %{value}<br>Percentage: %{percent}<extra></extra>",
        texttemplate: "%{percent}",
        textposition: "outside",
        textfont: {
          size: 10,
        },
      };

      const layout = {
        title: {
          text: "Coil Product Distribution",
          x: 0.5,
          y: 0.95,
          xanchor: "center",
          yanchor: "top",
          font: {
            size: 16,
          },
        },
        showlegend: false,
        height: 300,
        margin: { l: 20, r: 20, t: 40, b: 20 },
        plot_bgcolor: "white",
        modebar: {
          orientation: "h",
          bgcolor: "rgba(255,255,255,0.7)",
          position: "top-right",
        },
      };

      Plotly.newPlot(`${chartId}-chart`, [trace], layout, {
        displayModeBar: true,
        displaylogo: false,
        responsive: true,
        modeBarButtonsToRemove: [
          "lasso2d",
          "select2d",
          "zoomIn2d",
          "zoomOut2d",
          "autoScale2d",
        ],
      });
    }

    // Update the renderCoilAnalysisChart function to fix the right side overflow
    // Update the renderCoilAnalysisChart function to handle both aggregated and detailed views
function renderCoilAnalysisChart(data, chartId) {
  if (!data.dates || data.dates.length === 0) {
    $(`#${chartId}-chart`).html(
      '<div class="flex h-full items-center justify-center text-gray-500">No coil analysis data available</div>'
    );
    return;
  }

  const traces = [];
  let layout = {};

  if (data.chartType === 'detailed') {
    // Single day view: Show individual coil data with time
    traces.push(
      {
        x: data.dates,
        y: data.planThickness,
        name: "Planned Thickness",
        line: { color: "#1f77b4", width: 2 },
        mode: "lines+markers",
        hovertemplate:
          "<b>Serial No:</b> %{customdata}<br>" +
          "<b>Time:</b> %{x}<br>" +
          "<b>Planned Thickness:</b> %{y:.2f} mm<extra></extra>",
        customdata: data.serialNumbers,
      },
      {
        x: data.dates,
        y: data.finalThk,
        name: "Final Thickness",
        line: { color: "#ff7f0e", width: 2 },
        mode: "lines+markers",
        hovertemplate:
          "<b>Serial No:</b> %{customdata}<br>" +
          "<b>Time:</b> %{x}<br>" +
          "<b>Final Thickness:</b> %{y:.2f} mm<extra></extra>",
        customdata: data.serialNumbers,
      },
      {
        x: data.dates,
        y: data.planWidth,
        name: "Planned Width",
        line: { color: "#2ca02c", width: 2 },
        mode: "lines+markers",
        yaxis: "y2",
        hovertemplate:
          "<b>Serial No:</b> %{customdata}<br>" +
          "<b>Time:</b> %{x}<br>" +
          "<b>Planned Width:</b> %{y:.0f} mm<extra></extra>",
        customdata: data.serialNumbers,
      },
      {
        x: data.dates,
        y: data.finalWidth,
        name: "Final Width",
        line: { color: "#d62728", width: 2 },
        mode: "lines+markers",
        yaxis: "y2",
        hovertemplate:
          "<b>Serial No:</b> %{customdata}<br>" +
          "<b>Time:</b> %{x}<br>" +
          "<b>Final Width:</b> %{y:.0f} mm<extra></extra>",
        customdata: data.serialNumbers,
      }
    );

    layout = {
      title: "Detailed Coil Production Analysis (Single Day)",
      xaxis: {
        title: {
          text: "Time",
          standoff: 25,
        },
        tickangle: 45,
        tickformat: "%H:%M",
        tickfont: { size: 10 },
        type: "date",
        automargin: true,
      },
      yaxis: {
        title: "Thickness (mm)",
        side: "left",
        showgrid: true,
        gridcolor: "rgba(0,0,0,0.1)",
        automargin: true,
      },
      yaxis2: {
        title: "Width (mm)",
        side: "right",
        overlaying: "y",
        showgrid: false,
        gridcolor: "rgba(0,0,0,0.1)",
        automargin: true,
      },
    };
  } else if (data.chartType === 'aggregated') {
    // Multiple days view: Show aggregated data (no coil count bars, only in hover)
    traces.push(
      {
        x: data.dates,
        y: data.planThickness,
        name: "Avg Planned Thickness",
        line: { color: "#1f77b4", width: 3 },
        mode: "lines+markers",
        marker: { size: 8 },
        hovertemplate:
          "<b>Date:</b> %{x}<br>" +
          "<b>Avg Planned Thickness:</b> %{y:.2f} mm<br>" +
          "<b>Coils Produced:</b> %{customdata}<extra></extra>",
        customdata: data.coilCounts,
      },
      {
        x: data.dates,
        y: data.finalThk,
        name: "Avg Final Thickness",
        line: { color: "#ff7f0e", width: 3 },
        mode: "lines+markers",
        marker: { size: 8 },
        hovertemplate:
          "<b>Date:</b> %{x}<br>" +
          "<b>Avg Final Thickness:</b> %{y:.2f} mm<br>" +
          "<b>Coils Produced:</b> %{customdata}<extra></extra>",
        customdata: data.coilCounts,
      },
      {
        x: data.dates,
        y: data.planWidth,
        name: "Avg Planned Width",
        line: { color: "#2ca02c", width: 3 },
        mode: "lines+markers",
        marker: { size: 8 },
        yaxis: "y2",
        hovertemplate:
          "<b>Date:</b> %{x}<br>" +
          "<b>Avg Planned Width:</b> %{y:.0f} mm<br>" +
          "<b>Coils Produced:</b> %{customdata}<extra></extra>",
        customdata: data.coilCounts,
      },
      {
        x: data.dates,
        y: data.finalWidth,
        name: "Avg Final Width",
        line: { color: "#d62728", width: 3 },
        mode: "lines+markers",
        marker: { size: 8 },
        yaxis: "y2",
        hovertemplate:
          "<b>Date:</b> %{x}<br>" +
          "<b>Avg Final Width:</b> %{y:.0f} mm<br>" +
          "<b>Coils Produced:</b> %{customdata}<extra></extra>",
        customdata: data.coilCounts,
      }
    );

    layout = {
      title: "Aggregated Coil Production Analysis (Multiple Days)",
      xaxis: {
        title: {
          text: "Date",
          standoff: 25,
        },
        tickangle: 45,
        tickformat: "%Y-%m-%d",
        tickfont: { size: 10 },
        type: "date",
        automargin: true,
      },
      yaxis: {
        title: "Avg Thickness (mm)",
        side: "left",
        showgrid: true,
        gridcolor: "rgba(0,0,0,0.1)",
        automargin: true,
      },
      yaxis2: {
        title: "Avg Width (mm)",
        side: "right",
        overlaying: "y",
        showgrid: false,
        gridcolor: "rgba(0,0,0,0.1)",
        automargin: true,
      },
    };
  }

  // Common layout properties
  layout = {
    ...layout,
    legend: {
      orientation: "h",
      yanchor: "bottom",
      y: 1.02,
      xanchor: "right",
      x: 1,
    },
    hovermode: "closest",
    plot_bgcolor: "rgba(240, 240, 240, 0.8)",
    height: 500,
    margin: { l: 60, r: 80, t: 80, b: 80 },
    modebar: {
      orientation: "h",
      bgcolor: "rgba(255,255,255,0.7)",
      activecolor: "#1f77b4",
      position: "top-right",
    },
    autosize: true,
  };

  const config = {
    responsive: true,
    displayModeBar: true,
    displaylogo: false,
    modeBarButtonsToRemove: ["lasso2d", "select2d", "autoScale2d"],
    toImageButtonOptions: {
      format: "png",
      filename: "coil_production_analysis",
      height: 500,
      width: 1200,
      scale: 2,
    },
  };

  Plotly.newPlot(`${chartId}-chart`, traces, layout, config);

  // Add a resize handler to ensure the chart fits properly
  window.addEventListener("resize", function () {
    Plotly.relayout(`${chartId}-chart`, {
      "xaxis.automargin": true,
      "yaxis.automargin": true,
      "yaxis2.automargin": true,
    });
  });
}

    // Update the loadAnalysisData function
    // Update the loadAnalysisData function
function loadAnalysisData() {
  const fromDate = $("#analysis-from-date").val();
  const toDate = $("#analysis-to-date").val();
  const product = $("#analysis-product").val();

  // Always load data if we have from/to dates (including defaults)
  if (fromDate || toDate || product) {
    setControlsDisabled(true);
    $("#coil-analysis-loading").show();
    $("#analysis-default-message").hide();

    loadChart(
      "coil-analysis",
      "/production_overview/coil_analysis_chart",
      {
        from_date: fromDate,
        to_date: toDate,
        product: product,
      },
      function () {
        setControlsDisabled(false);
      }
    );
  } else {
    // Only show the message if no filters are applied at all
    $("#coil-analysis-chart").html(
      '<div class="flex h-full items-center justify-center text-gray-500">Please apply filters to view the analysis chart.</div>'
    );
    $("#coil-analysis-loading").hide();
  }
}

    // Update the update3DVisualization function
    function update3DVisualization() {
      const xAxis = $("#x-axis").val();
      const yAxis = $("#y-axis").val();
      const zAxis = $("#z-axis").val();
      const colorBy = $("#color-by").val();
      const visualizationType = $("#visualization-type").val();
      const fromDate = $("#viz-from-date").val();
      const toDate = $("#viz-to-date").val();
      const productFilter = $("#viz-product-filter").val(); // New product filter

      setControlsDisabled(true);
      $("#visualization-3d-loading").show();

      $.ajax({
        url: "/production_overview/visualization_3d",
        method: "GET",
        data: {
          x_axis: xAxis,
          y_axis: yAxis,
          z_axis: zAxis,
          color_by: colorBy,
          visualization_type: visualizationType,
          from_date: fromDate,
          to_date: toDate,
          product_filter: productFilter, // Include product filter
        },
        success: function (response) {
          if (response.visualization_3d) {
            $("#visualization-3d").html(response.visualization_3d);
          }
          $("#visualization-3d-loading").hide();
          setControlsDisabled(false);
        },
        error: function (xhr, status, error) {
          console.error("Error loading 3D visualization:", error);
          $("#visualization-3d-loading").hide();
          $("#visualization-3d").html(
            `<div class="flex h-full items-center justify-center text-gray-500">Error loading visualization. Please try again.</div>`
          );
          setControlsDisabled(false);
        },
      });
    }

    // Update the loadTableData function
    function loadTableData() {
      const fromDate = $("#table-from-date").val();
      const toDate = $("#table-to-date").val();
      const product = $("#table-product").val();
      const status = $("#table-status").val();
  
      // Get column search filters from table headers
      const columnSearchFilters = getColumnSearchFilters();

      setControlsDisabled(true);

      // Show loading indicator
      $("#table-body").html(
        '<tr><td colspan="100%" class="px-3 py-4 text-center text-gray-500">Loading data...</td></tr>'
      );

      // Prepare data object
      const requestData = {
        from_date: fromDate,
        to_date: toDate,
        product: product,
        status: status,
        page: currentPage,
        limit: itemsPerPage,
        sort_by: currentSortParam,
        sort_direction: currentSortDirection,
        column_search: JSON.stringify(columnSearchFilters)
      };

      $.ajax({
        url: "/production_overview/table_data",
        method: "GET",
        data: requestData,
        success: function (response) {
          tableData = response.data;
          totalPages = Math.ceil(response.total / itemsPerPage);

          // Update pagination info
          updatePaginationControls(
            (currentPage - 1) * itemsPerPage + 1,
            Math.min(currentPage * itemsPerPage, response.total),
            response.total
          );

          // Update table with data
          updateTableWithData(tableData);
          setControlsDisabled(false);
        },
        error: function (xhr, status, error) {
          console.error("Error loading table data:", error);
          $("#table-body").html(
            '<tr><td colspan="100%" class="px-3 py-4 text-center text-red-500">Error loading data. Please try again.</td></tr>'
          );
          setControlsDisabled(false);
        },
      });
    }

    function initializeDataTable() {
      // Only initialize once
      if (allColumns.length === 0) {
        // Fetch column definitions
        $.ajax({
          url: "/production_overview/table_columns",
          method: "GET",
          success: function (response) {
            allColumns = response.columns;
            visibleColumns =
              response.defaultVisible || allColumns.map((col) => col.field);

            // Generate column toggles
            generateColumnToggles();

            // Generate table header
            generateTableHeader();

            // Load initial data
            loadTableData();
          },
          error: function (xhr, status, error) {
            console.error("Error loading table columns:", error);
          },
        });
      } else {
        // Just reload the data
        loadTableData();
      }
    }

    function generateColumnToggles() {
      const container = $("#column-toggles");
      container.empty();

      allColumns.forEach((column) => {
        const isChecked = visibleColumns.includes(column.field);
        const toggle = `
        <label class="inline-flex items-center">
          <input type="checkbox" class="column-toggle" data-field="${
            column.field
          }" ${isChecked ? "checked" : ""}>
          <span class="ml-2 text-sm text-gray-700">${column.title}</span>
        </label>
      `;
        container.append(toggle);
      });

      // Add event listener for column toggles
      $(".column-toggle").on("change", function () {
        const field = $(this).data("field");
        if ($(this).is(":checked")) {
          if (!visibleColumns.includes(field)) {
            visibleColumns.push(field);
          }
        } else {
          visibleColumns = visibleColumns.filter((col) => col !== field);
        }

        // Regenerate table header and redraw table immediately
        generateTableHeader();
        updateTableWithData(tableData);
      });
    }

    function generateTableHeader() {
      const header = $("#table-header");
      header.empty();

      allColumns.forEach((column) => {
        if (visibleColumns.includes(column.field)) {
          // Add sortable class and sort indicators to headers
          const sortClass =
            column.field === currentSortParam
              ? currentSortDirection === "asc"
                ? "sort-asc"
                : "sort-desc"
              : "";
          const activeClass = column.field === currentSortParam ? "active" : "";

      // Create header cell with integrated search
      const headerCell = $(`
        <th scope="col" class="table-header-cell" data-field="${column.field}">
          <div class="header-content">
            <div class="header-title sortable-header" data-field="${column.field}">
              ${column.title}
              <span class="sort-indicator ${sortClass} ${activeClass}"></span>
            </div>
            ${tableSearchEnabled ? `
              <div class="header-search-container">
                <input 
                  type="text" 
                  class="header-search column-search-input" 
                  data-field="${column.field}"
                  placeholder="Type and press Enter..."
                />
                <button type="button" class="clear-search" data-field="${column.field}">×</button>
              </div>
            ` : ''}
          </div>
        </th>
      `);

      header.append(headerCell);
    }
  });

  // Add click handlers to sortable headers
  $(".sortable-header").on("click", function () {
    const field = $(this).data("field");

    // Initialize click count if not exists
    if (!sortClickCount[field]) {
      sortClickCount[field] = 0;
    }

    // Increment click count for this column
    sortClickCount[field]++;

    // Reset other columns' click counts
    Object.keys(sortClickCount).forEach((key) => {
      if (key !== field) sortClickCount[key] = 0;
    });

    // Three-state toggle: asc -> desc -> default
    if (sortClickCount[field] === 1) {
      // First click: sort ascending
      currentSortParam = field;
      currentSortDirection = "asc";
      sortingApplied = true;
    } else if (sortClickCount[field] === 2) {
      // Second click: sort descending
      currentSortParam = field;
      currentSortDirection = "desc";
      sortingApplied = true;
    } else {
      // Third click: reset to default
      currentSortParam = "slNo";
      currentSortDirection = "asc";
      sortingApplied = false;
      sortClickCount[field] = 0;
    }

    // Reload data with new sorting
    loadTableData();
  });

  // Add event listeners for column search inputs
  if (tableSearchEnabled) {
    // Change from 'input' event to 'keypress' event to detect Enter key
    $(".column-search-input").on("keypress", function(e) {
      if (e.which === 13) { // Enter key pressed
        applyColumnSearch();
      }
    });

    // Also add blur event for when user clicks away from input
    $(".column-search-input").on("blur", function() {
      applyColumnSearch();
    });

    // Add clear search button functionality
    $(".clear-search").on("click", function() {
      const field = $(this).data("field");
      $(`.column-search-input[data-field="${field}"]`).val('');
      applyColumnSearch();
    });
  }
}

    function updateTableWithData(data) {
      const tbody = $("#table-body");
      tbody.empty();

      if (data && data.length > 0) {
        data.forEach(function (item) {
          const row = $('<tr class="hover:bg-gray-50"></tr>');

          allColumns.forEach((column) => {
            if (visibleColumns.includes(column.field)) {
              let cellContent = "";

              // Format cell content based on column type
              if (column.field === "finalStatus") {
                const statusClass =
                  item.finalStatus === "Approved"
                    ? "badge-success"
                    : item.finalStatus === "Rejected"
                    ? "badge-danger"
                    : "badge-warning";
                cellContent = `<span class="badge ${statusClass}">${
                  item[column.field] || ""
                }</span>`;
              } else {
                cellContent =
                  item[column.field] !== undefined ? item[column.field] : "";
              }

              row.append(
                `<td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900">${cellContent}</td>`
              );
            }
          });

          tbody.append(row);
        });
      } else {
        tbody.append(
          '<tr><td colspan="100%" class="px-3 py-4 text-center text-gray-500">No data available</td></tr>'
        );
      }
    }

    function updatePaginationControls(start, end, total) {
      // Update pagination info text
      if (total > 0) {
        $("#pagination-info").text(
          `Showing ${start} to ${end} of ${total} entries`
        );
      } else {
        $("#pagination-info").text("Showing 0 to 0 of 0 entries");
      }

      // Update total pages
      $("#total-pages").text(totalPages);

      // Update current page input
      $("#current-page").val(currentPage);

      // Enable/disable previous button
      if (currentPage <= 1) {
        $("#prev-page").prop("disabled", true);
      } else {
        $("#prev-page").prop("disabled", false);
      }

      // Enable/disable next button
      if (currentPage >= totalPages) {
        $("#next-page").prop("disabled", true);
      } else {
        $("#next-page").prop("disabled", false);
      }
    }

    function fetchFilterOptions() {
      $.ajax({
        url: "/production_overview/filter_options",
        method: "GET",
        success: function (response) {
          productOptions = response.products || [];
          statusOptions = response.statuses || [];

          // Populate product dropdowns (including the new 3D viz product filter)
          const productSelects = $(
            "#analysis-product, #table-product, #viz-product-filter"
          );
          productSelects.empty();
          productSelects.append('<option value="">All Products</option>');

          productOptions.forEach((product) => {
            productSelects.append(
              `<option value="${product}">${product}</option>`
            );
          });

          // Populate status dropdown
          const statusSelect = $("#table-status");
          statusSelect.empty();
          statusSelect.append('<option value="">All Statuses</option>');

          statusOptions.forEach((status) => {
            statusSelect.append(`<option value="${status}">${status}</option>`);
          });
        },
        error: function (xhr, status, error) {
          console.error("Error loading filter options:", error);
        },
      });
    }

    function setupEventHandlers() {
      // Chart refresh buttons
      $(".refresh-chart").on("click", function () {
        const chartId = $(this).data("chart");

        if (chartId === "daily-coil") {
          loadChart(
            "daily-coil",
            "/production_overview/daily_production_chart"
          );
        } else if (chartId === "coil-distribution") {
          loadChart(
            "coil-distribution",
            "/production_overview/coil_distribution_chart"
          );
        } else if (chartId === "coil-analysis") {
          loadAnalysisData();
        }
      });

      // Chart expand buttons
      $(".expand-chart").on("click", function () {
        const chartId = $(this).data("chart");
        const chartTitle = $(this)
          .closest(".chart-card")
          .find(".chart-card-title")
          .text();
        const chartHtml = $(`#${chartId}-chart`).html();

        $("#expanded-chart-title").text(chartTitle);
        $("#expanded-chart-container").html(chartHtml);
        $("#expanded-chart-modal").show();
      });

      // Close expanded chart
      $("#close-expanded-chart").on("click", function () {
        $("#expanded-chart-modal").hide();
      });

      // Analysis filters
      $("#apply-analysis-filters").on("click", function () {
        loadAnalysisData();
      });

      // Reset analysis filters
      $("#reset-analysis-filters").on("click", function () {
        // Set default date range instead of clearing
        $("#analysis-from-date").val("2023-11-30");
        $("#analysis-to-date").val("2024-01-01");
        $("#analysis-product").val("");

        // Load data with default filters
        loadAnalysisData();
      });

      // 3D visualization update
      $("#update-3d-visualization").on("click", function () {
        update3DVisualization();
      });

      // Table filters
      $("#apply-table-filters").on("click", function () {
        currentPage = 1;
        loadTableData();
      });

      // Reset table filters - also clear column search
      $("#reset-table-filters").on("click", function () {
        $("#table-from-date").val("");
        $("#table-to-date").val("");
        $("#table-product").val("");
        $("#table-status").val("");
  
        // Clear column search inputs
        $(".column-search-input").val("");
  
        currentPage = 1;
        loadTableData();
      });

      // Table search toggle
      $("#enable-table-search").on("change", function() {
        tableSearchEnabled = $(this).is(":checked");
        generateTableHeader();
        updateTableWithData(tableData);
      });

      // Pagination handlers
      $("#items-per-page").on("change", function () {
        itemsPerPage = parseInt($(this).val());
        currentPage = 1; // Reset to first page when changing items per page
        loadTableData();
      });

      $("#prev-page").on("click", function () {
        if (currentPage > 1) {
          currentPage--;
          loadTableData();
        }
      });

      $("#next-page").on("click", function () {
        if (currentPage < totalPages) {
          currentPage++;
          loadTableData();
        }
      });

      $("#current-page").on("change", function () {
        const newPage = parseInt($(this).val());
        if (newPage >= 1 && newPage <= totalPages) {
          currentPage = newPage;
          loadTableData();
        } else {
          $(this).val(currentPage); // Reset to valid value
        }
      });

      // Export buttons
      $("#export-analysis-data").on("click", function () {
        exportData("analysis");
      });

      $("#export-3d-visualization").on("click", function () {
        exportData("3d");
      });

      $("#export-table-data").on("click", function () {
        exportData("table");
      });

      // Column selector button
      $("#column-selector-btn").on("click", function (e) {
        e.stopPropagation(); // Prevent immediate closing
        $("#column-dropdown").toggleClass("hidden");
      });

      // Close dropdown when clicking outside
      $(document).on("click", function (e) {
        if (
          !$(e.target).closest("#column-selector-btn, #column-dropdown").length
        ) {
          $("#column-dropdown").addClass("hidden");
        }
      });

      // Select all columns
      $("#select-all-columns").on("click", function () {
        allColumns.forEach((column) => {
          if (!visibleColumns.includes(column.field)) {
            visibleColumns.push(column.field);
          }
        });
        generateColumnToggles();
        generateTableHeader();
        updateTableWithData(tableData);
      });

      // Deselect all columns
      $("#deselect-all-columns").on("click", function () {
        visibleColumns = [];
        generateColumnToggles();
        generateTableHeader();
        updateTableWithData(tableData);
      });
    }

    // Add these new functions for integrated table search:

    function applyColumnSearch() {
      currentPage = 1; // Reset to first page when searching
      loadTableData();
    }

    function getColumnSearchFilters() {
      const filters = {};
      $(".column-search-input").each(function() {
        const field = $(this).data("field");
        const value = $(this).val().trim();
        if (value) {
          filters[field] = value;
        }
      });
      return filters;
    }

    // Debounce function to limit API calls while typing
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // Add date range validation for Production Analysis tab
    // Remove the date range validation for Production Analysis tab
function setupDateRangeValidation() {
  // Date range validation removed - users can now select any date range
  // The chart will automatically adapt to show aggregated or detailed view
}

    function showNotification(message, type = "info") {
      const notification = $("#notification");

      // Set message and type
      notification.text(message);
      notification.removeClass("info warning error success").addClass(type);

      // Show notification
      notification.css("display", "block");
      setTimeout(() => notification.addClass("show"), 10);

      // Hide after 3 seconds
      setTimeout(() => {
        notification.removeClass("show");
        setTimeout(() => notification.css("display", "none"), 300);
      }, 3000);
    }

    function exportData(type) {
      let url = "/export_data?type=" + type;

      if (type === "analysis") {
        const fromDate = $("#analysis-from-date").val();
        const toDate = $("#analysis-to-date").val();
        const product = $("#analysis-product").val();

        if (fromDate) url += `&from_date=${fromDate}`;
        if (toDate) url += `&to_date=${toDate}`;
        if (product) url += `&product=${product}`;
      } else if (type === "3d") {
        const xAxis = $("#x-axis").val();
        const yAxis = $("#y-axis").val();
        const zAxis = $("#z-axis").val();
        const colorBy = $("#color-by").val();
        const visualizationType = $("#visualization-type").val();
        const fromDate = $("#viz-from-date").val();
        const toDate = $("#viz-to-date").val();
        const productFilter = $("#viz-product-filter").val(); // Include product filter

        url += `&x_axis=${xAxis}&y_axis=${yAxis}&z_axis=${zAxis}&color_by=${colorBy}&visualization_type=${visualizationType}`;

        if (fromDate) url += `&from_date=${fromDate}`;
        if (toDate) url += `&to_date=${toDate}`;
        if (productFilter) url += `&product_filter=${productFilter}`;
      } else if (type === "table") {
        const fromDate = $("#table-from-date").val();
        const toDate = $("#table-to-date").val();
        const product = $("#table-product").val();
        const status = $("#table-status").val();

        if (fromDate) url += `&from_date=${fromDate}`;
        if (toDate) url += `&to_date=${toDate}`;
        if (product) url += `&product=${product}`;
        if (status) url += `&status=${status}`;

        // Only add sorting parameters if sorting has been explicitly applied
        if (sortingApplied) {
          url += `&sort_by=${currentSortParam}&sort_direction=${currentSortDirection}`;
        }
      }

      window.location.href = url;
    }

    // Add this function after the global variables section
function setControlsDisabled(disabled) {
  // Disable/enable all filter inputs and buttons
  const controls = [
    // Analysis tab controls
    '#analysis-from-date', '#analysis-to-date', '#analysis-product',
    '#apply-analysis-filters', '#reset-analysis-filters', '#export-analysis-data',
    
    // 3D visualization controls
    '#viz-from-date', '#viz-to-date', '#viz-product-filter',
    '#x-axis', '#y-axis', '#z-axis', '#color-by', '#visualization-type',
    '#update-3d-visualization', '#export-3d-visualization',
    
    // Table controls
    '#table-from-date', '#table-to-date', 
    '#table-product', '#table-status',
    '#apply-table-filters', '#reset-table-filters', '#export-table-data',
    
    // Pagination controls
    '#items-per-page', '#prev-page', '#next-page', '#current-page',
    
    // Column controls
    '#column-selector-btn', '#select-all-columns', '#deselect-all-columns',
    '.column-toggle', '#enable-table-search',
    
    // Column search inputs
    '.column-search-input',
    
    // Chart refresh buttons
    '.refresh-chart', '.expand-chart'
  ];
  
  controls.forEach(selector => {
    $(selector).prop('disabled', disabled);
    if (disabled) {
      $(selector).addClass('opacity-50 cursor-not-allowed');
    } else {
      $(selector).removeClass('opacity-50 cursor-not-allowed');
    }
  });
  
  // Also disable sortable headers
  if (disabled) {
    $('.sortable-header').addClass('pointer-events-none opacity-60');
  } else {
    $('.sortable-header').removeClass('pointer-events-none opacity-60');
  }
}
  });
</script>
{% endblock %}
