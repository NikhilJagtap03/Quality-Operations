{% extends "base.html" %} {% block title %}Production Overview - Quality
Operational Dashboard{% endblock %} {% block additional_head %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<style>
  body {
    overflow-x: hidden;
  }
  .dashboard-container {
    display: flex;
    flex-direction: column;
    width: 100%;
  }
  .tab-container {
    display: flex;
    border-bottom: 1px solid #e5e7eb;
    margin-bottom: 1rem;
    overflow-x: auto;
    scrollbar-width: thin;
  }
  .tab {
    padding: 0.75rem 1.5rem;
    font-weight: 500;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    white-space: nowrap;
  }
  .tab.active {
    border-bottom-color: #3b82f6;
    color: #3b82f6;
  }
  .tab-content {
    display: none;
  }
  .tab-content.active {
    display: block;
  }
  .chart-container {
    height: 320px;
    width: 100%;
    margin: 0 auto;
  }
  .chart-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1rem;
    margin-bottom: 1rem;
  }
  .chart-card {
    background-color: white;
    border-radius: 0.5rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    padding: 1rem;
    display: flex;
    flex-direction: column;
  }
  .chart-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
  }
  .chart-card-title {
    font-size: 1rem;
    font-weight: 600;
    color: #374151;
  }
  .chart-card-actions {
    display: flex;
    gap: 0.5rem;
  }
  .chart-card-body {
    flex: 1;
    min-height: 300px;
    position: relative;
  }
  .loading-indicator {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(255, 255, 255, 0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10;
  }
  .spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid #3b82f6;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  @keyframes spin {
    0% {
      transform: rotate(0deg);
    }
    100% {
      transform: rotate(360deg);
    }
  }
  .filter-container {
    background-color: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 0.375rem;
    padding: 1rem;
    margin-bottom: 1rem;
  }
  .filter-group {
    display: flex;
    gap: 1rem;
    align-items: center;
    flex-wrap: wrap;
  }
  .filter-item {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }
  .filter-label {
    font-size: 0.875rem;
    font-weight: 500;
    color: #4b5563;
  }
  .filter-input {
    padding: 0.5rem;
    border: 1px solid #d1d5db;
    border-radius: 0.375rem;
    font-size: 0.875rem;
  }
  .filter-button {
    padding: 0.5rem 1rem;
    border-radius: 0.375rem;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
  }
  .filter-button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    pointer-events: none;
  }
  .filter-button-primary {
    background-color: #3b82f6;
    color: white;
  }
  .filter-button-primary:hover {
    background-color: #2563eb;
  }
  .filter-button-secondary {
    background-color: #9ca3af;
    color: white;
  }
  .filter-button-secondary:hover {
    background-color: #6b7280;
  }
  .table-container {
    overflow-x: auto;
    max-width: 100%;
    background-color: white;
    border-radius: 0.5rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }
  .sticky-header th {
    position: sticky;
    top: 0;
    background-color: #f9fafb;
    z-index: 10;
  }
  .sortable-header {
    cursor: pointer;
    user-select: none;
    position: relative;
    padding-right: 1.5rem !important;
  }
  .sortable-header:hover {
    background-color: #f3f4f6;
  }
  .sort-indicator {
    position: absolute;
    right: 0.5rem;
    top: 50%;
    transform: translateY(-50%);
    display: inline-block;
    width: 0.75rem;
    height: 0.75rem;
    opacity: 0.5;
  }
  .sort-indicator.active {
    opacity: 1;
  }
  .sort-asc::after {
    content: "▲";
    font-size: 0.75rem;
  }
  .sort-desc::after {
    content: "▼";
    font-size: 0.75rem;
  }
  .pagination-controls {
    background-color: #f9fafb;
    border: 1px solid #e5e7eb;
    padding: 0.75rem;
    border-radius: 0.375rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 0.5rem;
  }
  .pagination-controls select,
  .pagination-controls input {
    border: 1px solid #d1d5db;
    border-radius: 0.25rem;
    padding: 0.25rem 0.5rem;
  }
  .pagination-controls button {
    transition: all 0.2s;
    padding: 0.25rem 0.75rem;
    border-radius: 0.25rem;
  }
  .pagination-controls button:not(:disabled):hover {
    background-color: #e5e7eb;
  }
  .pagination-controls button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  .axis-select {
    padding: 0.5rem;
    border: 1px solid #d1d5db;
    border-radius: 0.375rem;
    font-size: 0.875rem;
    background-color: white;
    min-width: 150px;
  }
  .visualization-controls {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    margin-bottom: 1rem;
  }
  .control-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }
  .control-label {
    font-size: 0.875rem;
    font-weight: 500;
    color: #4b5563;
  }
  .data-card {
    background-color: white;
    border-radius: 0.5rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
  }
  .data-card-value {
    font-size: 2rem;
    font-weight: 700;
    color: #3b82f6;
    margin: 0.5rem 0;
  }
  .data-card-label {
    font-size: 0.875rem;
    color: #6b7280;
  }
  .data-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 1rem;
  }
  .toggle-button {
    background: none;
    border: none;
    color: #6b7280;
    cursor: pointer;
    padding: 0.25rem;
    border-radius: 0.25rem;
    transition: all 0.2s;
  }
  .toggle-button:hover {
    background-color: #f3f4f6;
    color: #374151;
  }
  .toggle-button svg {
    width: 1.25rem;
    height: 1.25rem;
  }
  .expand-icon,
  .collapse-icon {
    display: inline-block;
    width: 1.25rem;
    height: 1.25rem;
  }
  .expand-icon::before {
    content: "⤢";
  }
  .collapse-icon::before {
    content: "⤡";
  }
  .expanded-chart {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(255, 255, 255, 0.95);
    z-index: 50;
    padding: 2rem;
    display: flex;
    flex-direction: column;
  }
  .expanded-chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
  }
  .expanded-chart-title {
    font-size: 1.5rem;
    font-weight: 600;
  }
  .expanded-chart-body {
    flex: 1;
    min-height: 0;
  }
  .expanded-chart .chart-container {
    height: 100%;
    width: 100%;
  }
  .close-button {
    background: none;
    border: none;
    color: #6b7280;
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 0.375rem;
    transition: all 0.2s;
    font-size: 1.5rem;
    line-height: 1;
  }
  .close-button:hover {
    background-color: #f3f4f6;
    color: #374151;
  }
  .badge {
    display: inline-flex;
    align-items: center;
    padding: 0.25rem 0.5rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 500;
  }
  .badge-success {
    background-color: #d1fae5;
    color: #065f46;
  }
  .badge-warning {
    background-color: #fef3c7;
    color: #92400e;
  }
  .badge-danger {
    background-color: #fee2e2;
    color: #b91c1c;
  }
  .badge-info {
    background-color: #e0f2fe;
    color: #0369a1;
  }
  .tooltip {
    position: relative;
    display: inline-block;
  }
  .tooltip .tooltip-text {
    visibility: hidden;
    width: 200px;
    background-color: #374151;
    color: white;
    text-align: center;
    border-radius: 6px;
    padding: 0.5rem;
    position: absolute;
    z-index: 1;
    bottom: 125%;
    left: 50%;
    transform: translateX(-50%);
    opacity: 0;
    transition: opacity 0.3s;
    font-size: 0.75rem;
  }
  .tooltip:hover .tooltip-text {
    visibility: visible;
    opacity: 1;
  }
</style>
{% endblock %} {% block content %}
<h1 class="text-3xl font-bold text-gray-800 mb-4">Production Overview</h1>

<div class="dashboard-container">
  <!-- Dashboard Tabs -->
  <div class="tab-container">
    <div class="tab active" data-tab="summary">Summary</div>
    <div class="tab" data-tab="production-analysis">Production Analysis</div>
    <div class="tab" data-tab="3d-visualization">3D Visualization</div>
    <div class="tab" data-tab="data-table">Data Table</div>
  </div>

  <!-- Summary Tab -->
  <div class="tab-content active" id="summary-tab">
    <!-- Summary Cards -->
    <div class="data-grid">
      <div class="data-card">
        <div class="data-card-label">Total Coils</div>
        <div class="data-card-value" id="total-coils">-</div>
        <div class="data-card-label">Production Units</div>
      </div>
      <div class="data-card">
        <div class="data-card-label">Average Thickness</div>
        <div class="data-card-value" id="avg-thickness">-</div>
        <div class="data-card-label">mm</div>
      </div>
      <div class="data-card">
        <div class="data-card-label">Average Width</div>
        <div class="data-card-value" id="avg-width">-</div>
        <div class="data-card-label">mm</div>
      </div>
      <div class="data-card">
        <div class="data-card-label">Approval Rate</div>
        <div class="data-card-value" id="approval-rate">-</div>
        <div class="data-card-label">% Approved</div>
      </div>
    </div>

    <!-- Summary Charts -->
    <div class="chart-grid">
      <div class="chart-card">
        <div class="chart-card-header">
          <div class="chart-card-title">Daily Coil Production</div>
          <div class="chart-card-actions">
            <button class="toggle-button refresh-chart" data-chart="daily-coil">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                />
              </svg>
            </button>
            <button class="toggle-button expand-chart" data-chart="daily-coil">
              <span class="expand-icon"></span>
            </button>
          </div>
        </div>
        <div class="chart-card-body">
          <div class="loading-indicator" id="daily-coil-loading">
            <div class="spinner"></div>
          </div>
          <div class="chart-container" id="daily-coil-chart"></div>
        </div>
      </div>
      <div class="chart-card">
        <div class="chart-card-header">
          <div class="chart-card-title">Coil Product Distribution</div>
          <div class="chart-card-actions">
            <button
              class="toggle-button refresh-chart"
              data-chart="coil-distribution"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                />
              </svg>
            </button>
            <button
              class="toggle-button expand-chart"
              data-chart="coil-distribution"
            >
              <span class="expand-icon"></span>
            </button>
          </div>
        </div>
        <div class="chart-card-body">
          <div class="loading-indicator" id="coil-distribution-loading">
            <div class="spinner"></div>
          </div>
          <div class="chart-container" id="coil-distribution-chart"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Production Analysis Tab -->
  <div class="tab-content" id="production-analysis-tab">
    <!-- Filter Controls -->
    <div class="filter-container">
      <div class="filter-group">
        <div class="filter-item">
          <label class="filter-label">From Date</label>
          <input
            type="date"
            id="analysis-from-date"
            class="filter-input"
            placeholder="Select date"
          />
        </div>
        <div class="filter-item">
          <label class="filter-label">To Date</label>
          <input
            type="date"
            id="analysis-to-date"
            class="filter-input"
            placeholder="Select date"
          />
        </div>
        <div class="filter-item">
          <label class="filter-label">Product</label>
          <select id="analysis-product" class="filter-input">
            <option value="">All Products</option>
            <!-- Products will be populated dynamically -->
          </select>
        </div>
        <div class="filter-item mt-auto">
          <button
            id="apply-analysis-filters"
            class="filter-button filter-button-primary"
          >
            Apply Filters
          </button>
        </div>
        <div class="filter-item mt-auto">
          <button
            id="reset-analysis-filters"
            class="filter-button filter-button-secondary"
          >
            Reset Filters
          </button>
        </div>
        <div class="filter-item mt-auto">
          <button
            id="export-analysis-data"
            class="filter-button filter-button-secondary"
          >
            Export
          </button>
        </div>
      </div>
    </div>

    <!-- Analysis Charts -->
    <div class="chart-card mb-6">
      <div class="chart-card-header">
        <div class="chart-card-title">Coil Production Analysis</div>
        <div class="chart-card-actions">
          <button
            class="toggle-button refresh-chart"
            data-chart="coil-analysis"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
              />
            </svg>
          </button>
          <button class="toggle-button expand-chart" data-chart="coil-analysis">
            <span class="expand-icon"></span>
          </button>
        </div>
      </div>
      <div class="chart-card-body" style="height: 500px">
        <div
          class="loading-indicator"
          id="coil-analysis-loading"
          style="display: none"
        >
          <div class="spinner"></div>
        </div>
        <div
          class="chart-container"
          id="coil-analysis-chart"
          style="height: 100%"
        >
          <div
            class="flex h-full items-center justify-center text-gray-500"
            id="analysis-default-message"
          >
            Please apply filters to view the analysis chart.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 3D Visualization Tab -->
  <div class="tab-content" id="3d-visualization-tab">
    <div class="filter-container">
      <div class="visualization-controls">
        <div class="filter-item">
          <label class="filter-label">From Date</label>
          <input
            type="date"
            id="viz-from-date"
            class="filter-input"
            placeholder="Select date"
          />
        </div>
        <div class="filter-item">
          <label class="filter-label">To Date</label>
          <input
            type="date"
            id="viz-to-date"
            class="filter-input"
            placeholder="Select date"
          />
        </div>
        <div class="control-group">
          <label class="control-label" for="x-axis">X-Axis Parameter:</label>
          <select id="x-axis" class="axis-select">
            <option value="finalThk">Final Thickness</option>
            <option value="planThickness">Planned Thickness</option>
            <option value="finalWidth">Final Width</option>
            <option value="planWidth">Planned Width</option>
            <option value="finalWeight">Final Weight</option>
            <option value="yieldStrength">Yield Strength</option>
            <option value="elongation">Elongation</option>
            <option value="hardness">Hardness</option>
            <option value="age">Age</option>
          </select>
        </div>

        <div class="control-group">
          <label class="control-label" for="y-axis">Y-Axis Parameter:</label>
          <select id="y-axis" class="axis-select">
            <option value="finalWidth">Final Width</option>
            <option value="finalThk">Final Thickness</option>
            <option value="planThickness">Planned Thickness</option>
            <option value="planWidth">Planned Width</option>
            <option value="finalWeight">Final Weight</option>
            <option value="yieldStrength">Yield Strength</option>
            <option value="elongation">Elongation</option>
            <option value="hardness">Hardness</option>
            <option value="age">Age</option>
          </select>
        </div>

        <div class="control-group">
          <label class="control-label" for="z-axis">Z-Axis Parameter:</label>
          <select id="z-axis" class="axis-select">
            <option value="finalWeight">Final Weight</option>
            <option value="finalThk">Final Thickness</option>
            <option value="planThickness">Planned Thickness</option>
            <option value="finalWidth">Final Width</option>
            <option value="planWidth">Planned Width</option>
            <option value="yieldStrength">Yield Strength</option>
            <option value="elongation">Elongation</option>
            <option value="hardness">Hardness</option>
            <option value="age">Age</option>
          </select>
        </div>

        <div class="control-group">
          <label class="control-label" for="color-by">Color By:</label>
          <select id="color-by" class="axis-select">
            <option value="product">Product</option>
            <option value="finalStatus">Final Status</option>
            <option value="material">Material</option>
            <option value="shift">Shift</option>
          </select>
        </div>

        <div class="control-group">
          <label class="control-label" for="visualization-type"
            >Visualization Type:</label
          >
          <select id="visualization-type" class="axis-select">
            <option value="scatter">3D Scatter</option>
            <option value="surface">3D Surface</option>
            <option value="mesh">3D Mesh</option>
          </select>
        </div>

        <div class="control-group mt-auto">
          <button
            id="update-3d-visualization"
            class="filter-button filter-button-primary"
          >
            Update Visualization
          </button>
        </div>

        <div class="control-group mt-auto">
          <button
            id="export-3d-visualization"
            class="filter-button filter-button-secondary"
          >
            Export
          </button>
        </div>
      </div>
    </div>

    <div class="chart-card">
      <div class="chart-card-header">
        <div class="chart-card-title">3D Parameter Visualization</div>
        <div class="chart-card-actions">
          <div class="tooltip">
            <button class="toggle-button" id="3d-help">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                />
              </svg>
            </button>
            <span class="tooltip-text"
              >The visualization shows all available data points by default. Use
              the date range filters to limit the data if needed for better
              performance.</span
            >
          </div>
          <button
            class="toggle-button expand-chart"
            data-chart="3d-visualization"
          >
            <span class="expand-icon"></span>
          </button>
        </div>
      </div>
      <div class="chart-card-body" style="height: 600px">
        <div class="loading-indicator" id="visualization-3d-loading">
          <div class="spinner"></div>
        </div>
        <div class="chart-container" id="visualization-3d" style="height: 100%">
          <div class="flex h-full items-center justify-center text-gray-500">
            Click "Update Visualization" to generate the 3D view.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Data Table Tab -->
  <div class="tab-content" id="data-table-tab">
    <!-- Table Filters -->
    <div class="filter-container">
      <div class="filter-group">
        <div class="filter-item">
          <label class="filter-label">Serial No</label>
          <input
            type="text"
            id="table-serial-no"
            class="filter-input"
            placeholder="Search by Serial No"
          />
        </div>
        <div class="filter-item">
          <label class="filter-label">From Date</label>
          <input
            type="date"
            id="table-from-date"
            class="filter-input"
            placeholder="Select date"
          />
        </div>
        <div class="filter-item">
          <label class="filter-label">To Date</label>
          <input
            type="date"
            id="table-to-date"
            class="filter-input"
            placeholder="Select date"
          />
        </div>
        <div class="filter-item">
          <label class="filter-label">Product</label>
          <select id="table-product" class="filter-input">
            <option value="">All Products</option>
            <!-- Products will be populated dynamically -->
          </select>
        </div>
        <div class="filter-item">
          <label class="filter-label">Status</label>
          <select id="table-status" class="filter-input">
            <option value="">All Statuses</option>
            <option value="Approved">Approved</option>
            <option value="Rejected">Rejected</option>
            <option value="Pending">Pending</option>
          </select>
        </div>
        <div class="filter-item mt-auto">
          <button
            id="apply-table-filters"
            class="filter-button filter-button-primary"
          >
            Apply Filters
          </button>
        </div>
        <div class="filter-item mt-auto">
          <button
            id="reset-table-filters"
            class="filter-button filter-button-secondary"
          >
            Reset Filters
          </button>
        </div>
        <div class="filter-item mt-auto">
          <button
            id="export-table-data"
            class="filter-button filter-button-secondary"
          >
            Export
          </button>
        </div>
      </div>
    </div>

    <!-- Replace with a more compact column selector dropdown -->
    <div class="filter-container mb-4">
      <div class="flex justify-between items-center">
        <div class="font-medium text-gray-700">Table Columns</div>
        <div class="relative">
          <button
            id="column-selector-btn"
            class="filter-button filter-button-secondary flex items-center gap-2"
          >
            <span>Show/Hide Columns</span>
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="m6 9 6 6 6-6" />
            </svg>
          </button>
          <div
            id="column-dropdown"
            class="absolute right-0 mt-2 bg-white border border-gray-200 rounded-md shadow-lg z-20 p-3 hidden"
            style="width: 280px; max-height: 400px; overflow-y: auto"
          >
            <div
              class="flex justify-between mb-2 pb-2 border-b border-gray-200"
            >
              <button
                id="select-all-columns"
                class="text-sm text-blue-600 hover:text-blue-800"
              >
                Select All
              </button>
              <button
                id="deselect-all-columns"
                class="text-sm text-blue-600 hover:text-blue-800"
              >
                Deselect All
              </button>
            </div>
            <div id="column-toggles" class="grid grid-cols-1 gap-1">
              <!-- Column toggles will be populated dynamically -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Data Table -->
    <div class="table-container mb-4">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50 sticky-header">
          <tr id="table-header">
            <!-- Table headers will be populated dynamically -->
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200" id="table-body">
          <!-- Table rows will be populated dynamically -->
          <tr>
            <td colspan="100%" class="px-3 py-4 text-center text-gray-500">
              Loading data...
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Pagination controls -->
    <div class="pagination-controls mb-6">
      <div class="flex items-center space-x-2">
        <span class="text-sm text-gray-600">Show</span>
        <select id="items-per-page" class="text-sm border rounded p-1">
          <option value="10" selected>10</option>
          <option value="25">25</option>
          <option value="50">50</option>
          <option value="100">100</option>
        </select>
        <span class="text-sm text-gray-600">entries</span>
      </div>
      <div class="text-sm text-gray-600" id="pagination-info">
        Showing 0 to 0 of 0 entries
      </div>
      <div class="flex space-x-2">
        <button
          id="prev-page"
          class="px-3 py-1 bg-gray-200 text-gray-700 rounded disabled:opacity-50 disabled:cursor-not-allowed"
        >
          Previous
        </button>
        <div class="flex items-center px-3 py-1 bg-white border rounded">
          <span class="text-sm">Page</span>
          <input
            type="number"
            id="current-page"
            class="w-12 text-center mx-2 border-0 focus:outline-none"
            value="1"
            min="1"
          />
          <span class="text-sm">of <span id="total-pages">1</span></span>
        </div>
        <button
          id="next-page"
          class="px-3 py-1 bg-gray-200 text-gray-700 rounded disabled:opacity-50 disabled:cursor-not-allowed"
        >
          Next
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Expanded Chart Modal -->
<div id="expanded-chart-modal" style="display: none" class="expanded-chart">
  <div class="expanded-chart-header">
    <div class="expanded-chart-title" id="expanded-chart-title">
      Chart Title
    </div>
    <button class="close-button" id="close-expanded-chart">×</button>
  </div>
  <div class="expanded-chart-body">
    <div class="chart-container" id="expanded-chart-container"></div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  $(document).ready(function () {
    // Update the tab switching function to not auto-load 3D visualization
    // Tab switching
    $(".tab").on("click", function () {
      const tabId = $(this).data("tab");

      // Update active tab
      $(".tab").removeClass("active");
      $(this).addClass("active");

      // Show corresponding content
      $(".tab-content").removeClass("active");
      $(`#${tabId}-tab`).addClass("active");

      // Load data for the selected tab
      if (tabId === "summary") {
        loadSummaryData();
      } else if (tabId === "production-analysis") {
        // Don't auto-load analysis data, wait for user to apply filters
        // Just show the filter controls
      } else if (tabId === "3d-visualization") {
        // Automatically load 3D visualization when tab is selected
        $("#visualization-3d").html(
          '<div class="flex h-full items-center justify-center text-gray-500">Loading 3D visualization...</div>'
        );
        update3DVisualization();
      } else if (tabId === "data-table") {
        initializeDataTable();
      }
    });

    // Pagination variables
    let currentPage = 1;
    let itemsPerPage = 10;
    let totalPages = 1;
    let paginatedData = [];
    let tableData = [];
    let allColumns = [];
    let visibleColumns = [];
    let productOptions = [];
    let statusOptions = [];

    // Global variables for sorting
    let currentSortParam = "slNo";
    let currentSortDirection = "asc";
    let sortingApplied = false;
    let sortClickCount = {}; // Track clicks per column for 3-state sorting

    // Cache for summary data
    let summaryDataCache = null;
    let summaryChartsLoaded = false;

    // Initialize the dashboard
    initializeDashboard();

    function initializeDashboard() {
      // Load initial summary data
      loadSummaryData();

      // Fetch product and status options for filters
      fetchFilterOptions();

      // Set up event handlers
      setupEventHandlers();
    }

    function loadSummaryData() {
      // Show loading indicators
      $("#daily-coil-loading, #coil-distribution-loading").show();

      // Load summary metrics
      $.ajax({
        url: "/production_overview/summary_metrics",
        method: "GET",
        success: function (response) {
          // Cache the response
          summaryDataCache = response;
          updateSummaryCards(response);
        },
        error: function (xhr, status, error) {
          console.error("Error loading summary metrics:", error);
        },
      });

      // Always reload charts to ensure they're properly displayed
      loadChart("daily-coil", "/production_overview/daily_production_chart");
      loadChart(
        "coil-distribution",
        "/production_overview/coil_distribution_chart",
        {},
        function () {
          summaryChartsLoaded = true;
        }
      );
    }

    function updateSummaryCards(data) {
      $("#total-coils").text(data.totalCoils || "-");
      $("#avg-thickness").text(
        data.avgThickness ? data.avgThickness.toFixed(2) : "-"
      );
      $("#avg-width").text(data.avgWidth ? data.avgWidth.toFixed(0) : "-");
      $("#approval-rate").text(
        data.approvalRate ? data.approvalRate.toFixed(1) + "%" : "-"
      );
    }

    // Modify the loadChart function to handle callback for error cases too
    function loadChart(chartId, endpoint, params = {}, callback) {
      $(`#${chartId}-loading`).show();

      $.ajax({
        url: endpoint,
        method: "GET",
        data: params,
        success: function (response) {
          // Clear any previous chart
          $(`#${chartId}-chart`).empty();

          if (chartId === "daily-coil") {
            renderDailyCoilChart(response, chartId);
          } else if (chartId === "coil-distribution") {
            renderCoilDistributionChart(response, chartId);
          } else if (chartId === "coil-analysis") {
            renderCoilAnalysisChart(response, chartId);
          }

          $(`#${chartId}-loading`).hide();

          if (typeof callback === "function") {
            callback();
          }
        },
        error: function (xhr, status, error) {
          console.error(`Error loading ${chartId} chart:`, error);
          $(`#${chartId}-loading`).hide();
          $(`#${chartId}-chart`).html(
            `<div class="flex h-full items-center justify-center text-gray-500">Error loading chart. Please try again.</div>`
          );

          if (typeof callback === "function") {
            callback(error);
          }
        },
      });
    }

    // Add new functions to render charts with Plotly
    function renderDailyCoilChart(data, chartId) {
      if (!data.labels || data.labels.length === 0) {
        $(`#${chartId}-chart`).html(
          '<div class="flex h-full items-center justify-center text-gray-500">No daily production data available</div>'
        );
        return;
      }

      const trace = {
        x: data.labels,
        y: data.data,
        type: "bar",
        marker: {
          color: "rgb(55, 83, 109)",
        },
        text: data.data,
        textposition: "auto",
        hovertemplate: "Number of Coils: %{y}<extra></extra>",
      };

      const layout = {
        title: "Daily Coil Production",
        xaxis: {
          title: "Date",
          tickangle: 45,
        },
        yaxis: {
          title: "Number of Coils",
        },
        plot_bgcolor: "rgba(242, 244, 247, 1)",
        paper_bgcolor: "white",
        height: 300,
        margin: { l: 40, r: 40, t: 40, b: 40 },
      };

      Plotly.newPlot(`${chartId}-chart`, [trace], layout, {
        displayModeBar: false,
        responsive: true,
      });
    }

    function renderCoilDistributionChart(data, chartId) {
      if (!data.labels || data.labels.length === 0) {
        $(`#${chartId}-chart`).html(
          '<div class="flex h-full items-center justify-center text-gray-500">No coil product data available</div>'
        );
        return;
      }

      // Define a colorful palette
      const colors = [
        "rgb(82, 113, 255)", // Blue
        "rgb(255, 99, 71)", // Coral
        "rgb(34, 197, 94)", // Green
        "rgb(168, 85, 247)", // Purple
        "rgb(251, 146, 60)", // Orange
        "rgb(236, 72, 153)", // Pink
        "rgb(234, 179, 8)", // Yellow
      ];

      const trace = {
        labels: data.labels,
        values: data.data,
        type: "pie",
        hole: 0.4,
        marker: {
          colors: colors,
        },
        textinfo: "label+percent",
        hovertemplate:
          "<b>%{label}</b><br>Count: %{value}<br>Percentage: %{percent}<extra></extra>",
        texttemplate: "%{percent}",
        textposition: "outside",
        textfont: {
          size: 10,
        },
      };

      const layout = {
        title: {
          text: "Coil Product Distribution",
          x: 0.5,
          y: 0.95,
          xanchor: "center",
          yanchor: "top",
          font: {
            size: 16,
          },
        },
        showlegend: false,
        height: 300,
        margin: { l: 20, r: 20, t: 40, b: 20 },
        plot_bgcolor: "white",
      };

      Plotly.newPlot(`${chartId}-chart`, [trace], layout, {
        displayModeBar: false,
        responsive: true,
      });
    }

    function renderCoilAnalysisChart(data, chartId) {
      if (!data.dates || data.dates.length === 0) {
        $(`#${chartId}-chart`).html(
          '<div class="flex h-full items-center justify-center text-gray-500">No coil analysis data available</div>'
        );
        return;
      }

      const traces = [
        // Thickness comparison
        {
          x: data.dates,
          y: data.planThickness,
          name: "Planned Thickness",
          line: { color: "#1f77b4", width: 2 },
          mode: "lines+markers",
          hovertemplate:
            "<b>Product:</b> %{customdata}<br>" +
            "<b>Date:</b> %{x}<br>" +
            "<b>Planned Thickness:</b> %{y:.2f} mm<extra></extra>",
          customdata: data.products,
        },
        {
          x: data.dates,
          y: data.finalThk,
          name: "Final Thickness",
          line: { color: "#ff7f0e", width: 2 },
          mode: "lines+markers",
          hovertemplate:
            "<b>Product:</b> %{customdata}<br>" +
            "<b>Date:</b> %{x}<br>" +
            "<b>Final Thickness:</b> %{y:.2f} mm<extra></extra>",
          customdata: data.products,
        },
        // Width comparison
        {
          x: data.dates,
          y: data.planWidth,
          name: "Planned Width",
          line: { color: "#2ca02c", width: 2 },
          mode: "lines+markers",
          yaxis: "y2",
          hovertemplate:
            "<b>Product:</b> %{customdata}<br>" +
            "<b>Date:</b> %{x}<br>" +
            "<b>Planned Width:</b> %{y:.0f} mm<extra></extra>",
          customdata: data.products,
        },
        {
          x: data.dates,
          y: data.finalWidth,
          name: "Final Width",
          line: { color: "#d62728", width: 2 },
          mode: "lines+markers",
          yaxis: "y2",
          hovertemplate:
            "<b>Product:</b> %{customdata}<br>" +
            "<b>Date:</b> %{x}<br>" +
            "<b>Final Width:</b> %{y:.0f} mm<extra></extra>",
          customdata: data.products,
        },
      ];

      const layout = {
        title: "Coil Production Analysis",
        xaxis: {
          title: "Date and Time",
          tickangle: 45,
          tickformat: "%Y-%m-%d",
          tickfont: { size: 10 },
          type: "date",
        },
        yaxis: {
          title: "Thickness (mm)",
          side: "left",
          showgrid: true,
          gridcolor: "rgba(0,0,0,0.1)",
        },
        yaxis2: {
          title: "Width (mm)",
          side: "right",
          overlaying: "y",
          showgrid: false,
          gridcolor: "rgba(0,0,0,0.1)",
        },
        legend: {
          orientation: "h",
          yanchor: "bottom",
          y: 1.02,
          xanchor: "right",
          x: 1,
        },
        hovermode: "closest",
        plot_bgcolor: "rgba(240, 240, 240, 0.8)",
        height: 500,
        margin: { l: 50, r: 50, t: 80, b: 50 },
      };

      Plotly.newPlot(`${chartId}-chart`, traces, layout, {
        responsive: true,
      });
    }

    // Update the loadAnalysisData function
    function loadAnalysisData() {
      const fromDate = $("#analysis-from-date").val();
      const toDate = $("#analysis-to-date").val();
      const product = $("#analysis-product").val();

      // Check if any filters are applied
      if (!fromDate && !toDate && !product) {
        // No filters applied, show default message and clear chart
        $("#coil-analysis-chart").html(
          '<div class="flex h-full items-center justify-center text-gray-500">Please apply filters to view the analysis chart.</div>'
        );
        $("#coil-analysis-loading").hide();
        return;
      }

      // Disable buttons during loading
      $(
        "#apply-analysis-filters, #reset-analysis-filters, #export-analysis-data"
      ).prop("disabled", true);

      $("#coil-analysis-loading").show();
      $("#analysis-default-message").hide();

      loadChart(
        "coil-analysis",
        "/production_overview/coil_analysis_chart",
        {
          from_date: fromDate,
          to_date: toDate,
          product: product,
        },
        function () {
          // Re-enable buttons after loading completes
          $(
            "#apply-analysis-filters, #reset-analysis-filters, #export-analysis-data"
          ).prop("disabled", false);
        }
      );
    }

    // Update the update3DVisualization function
    function update3DVisualization() {
      const xAxis = $("#x-axis").val();
      const yAxis = $("#y-axis").val();
      const zAxis = $("#z-axis").val();
      const colorBy = $("#color-by").val();
      const visualizationType = $("#visualization-type").val();
      const fromDate = $("#viz-from-date").val();
      const toDate = $("#viz-to-date").val();

      // Disable buttons during loading
      $("#update-3d-visualization, #export-3d-visualization").prop(
        "disabled",
        true
      );

      $("#visualization-3d-loading").show();

      $.ajax({
        url: "/production_overview/visualization_3d",
        method: "GET",
        data: {
          x_axis: xAxis,
          y_axis: yAxis,
          z_axis: zAxis,
          color_by: colorBy,
          visualization_type: visualizationType,
          from_date: fromDate,
          to_date: toDate,
        },
        success: function (response) {
          if (response.visualization_3d) {
            $("#visualization-3d").html(response.visualization_3d);
          }
          $("#visualization-3d-loading").hide();

          // Re-enable buttons after loading completes
          $("#update-3d-visualization, #export-3d-visualization").prop(
            "disabled",
            false
          );
        },
        error: function (xhr, status, error) {
          console.error("Error loading 3D visualization:", error);
          $("#visualization-3d-loading").hide();
          $("#visualization-3d").html(
            `<div class="flex h-full items-center justify-center text-gray-500">Error loading visualization. Please try again.</div>`
          );

          // Re-enable buttons after error
          $("#update-3d-visualization, #export-3d-visualization").prop(
            "disabled",
            false
          );
        },
      });
    }

    // Update the loadTableData function
    function loadTableData() {
      const serialNo = $("#table-serial-no").val();
      const fromDate = $("#table-from-date").val();
      const toDate = $("#table-to-date").val();
      const product = $("#table-product").val();
      const status = $("#table-status").val();

      // Disable buttons during loading
      $(
        "#apply-table-filters, #reset-table-filters, #export-table-data, #clear-sorting"
      ).prop("disabled", true);
      $(".sort-button").addClass("pointer-events-none opacity-60");

      // Show loading indicator
      $("#table-body").html(
        '<tr><td colspan="100%" class="px-3 py-4 text-center text-gray-500">Loading data...</td></tr>'
      );

      $.ajax({
        url: "/production_overview/table_data",
        method: "GET",
        data: {
          serial_no: serialNo,
          from_date: fromDate,
          to_date: toDate,
          product: product,
          status: status,
          page: currentPage,
          limit: itemsPerPage,
          sort_by: currentSortParam,
          sort_direction: currentSortDirection,
        },
        success: function (response) {
          tableData = response.data;
          totalPages = Math.ceil(response.total / itemsPerPage);

          // Update pagination info
          updatePaginationControls(
            (currentPage - 1) * itemsPerPage + 1,
            Math.min(currentPage * itemsPerPage, response.total),
            response.total
          );

          // Update table with data
          updateTableWithData(tableData);

          // Re-enable buttons after loading completes
          $(
            "#apply-table-filters, #reset-table-filters, #export-table-data, #clear-sorting"
          ).prop("disabled", false);
          $(".sort-button").removeClass("pointer-events-none opacity-60");
        },
        error: function (xhr, status, error) {
          console.error("Error loading table data:", error);
          $("#table-body").html(
            '<tr><td colspan="100%" class="px-3 py-4 text-center text-red-500">Error loading data. Please try again.</td></tr>'
          );

          // Re-enable buttons after error
          $(
            "#apply-table-filters, #reset-table-filters, #export-table-data, #clear-sorting"
          ).prop("disabled", false);
          $(".sort-button").removeClass("pointer-events-none opacity-60");
        },
      });
    }

    function initializeDataTable() {
      // Only initialize once
      if (allColumns.length === 0) {
        // Fetch column definitions
        $.ajax({
          url: "/production_overview/table_columns",
          method: "GET",
          success: function (response) {
            allColumns = response.columns;
            visibleColumns =
              response.defaultVisible || allColumns.map((col) => col.field);

            // Generate column toggles
            generateColumnToggles();

            // Generate table header
            generateTableHeader();

            // Load initial data
            loadTableData();
          },
          error: function (xhr, status, error) {
            console.error("Error loading table columns:", error);
          },
        });
      } else {
        // Just reload the data
        loadTableData();
      }
    }

    function generateColumnToggles() {
      const container = $("#column-toggles");
      container.empty();

      allColumns.forEach((column) => {
        const isChecked = visibleColumns.includes(column.field);
        const toggle = `
        <label class="inline-flex items-center">
          <input type="checkbox" class="column-toggle" data-field="${
            column.field
          }" ${isChecked ? "checked" : ""}>
          <span class="ml-2 text-sm text-gray-700">${column.title}</span>
        </label>
      `;
        container.append(toggle);
      });

      // Add event listener for column toggles
      $(".column-toggle").on("change", function () {
        const field = $(this).data("field");
        if ($(this).is(":checked")) {
          if (!visibleColumns.includes(field)) {
            visibleColumns.push(field);
          }
        } else {
          visibleColumns = visibleColumns.filter((col) => col !== field);
        }

        // Regenerate table header and redraw table immediately
        generateTableHeader();
        updateTableWithData(tableData);
      });
    }

    function generateTableHeader() {
      const header = $("#table-header");
      header.empty();

      allColumns.forEach((column) => {
        if (visibleColumns.includes(column.field)) {
          // Add sortable class and sort indicators to headers
          const sortClass =
            column.field === currentSortParam
              ? currentSortDirection === "asc"
                ? "sort-asc"
                : "sort-desc"
              : "";
          const activeClass = column.field === currentSortParam ? "active" : "";

          header.append(`
        <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" data-field="${column.field}">
          ${column.title}
          <span class="sort-indicator ${sortClass} ${activeClass}"></span>
        </th>
      `);
        }
      });

      // Add click handlers to sortable headers
      $(".sortable-header").on("click", function () {
        const field = $(this).data("field");

        // Initialize click count if not exists
        if (!sortClickCount[field]) {
          sortClickCount[field] = 0;
        }

        // Increment click count for this column
        sortClickCount[field]++;

        // Reset other columns' click counts
        Object.keys(sortClickCount).forEach((key) => {
          if (key !== field) sortClickCount[key] = 0;
        });

        // Three-state toggle: asc -> desc -> default
        if (sortClickCount[field] === 1) {
          // First click: sort ascending
          currentSortParam = field;
          currentSortDirection = "asc";
          sortingApplied = true;
        } else if (sortClickCount[field] === 2) {
          // Second click: sort descending
          currentSortParam = field;
          currentSortDirection = "desc";
          sortingApplied = true;
        } else {
          // Third click: reset to default
          currentSortParam = "slNo";
          currentSortDirection = "asc";
          sortingApplied = false;
          sortClickCount[field] = 0;
        }

        // Reload data with new sorting
        loadTableData();
      });
    }

    function updateTableWithData(data) {
      const tbody = $("#table-body");
      tbody.empty();

      if (data && data.length > 0) {
        data.forEach(function (item) {
          const row = $('<tr class="hover:bg-gray-50"></tr>');

          allColumns.forEach((column) => {
            if (visibleColumns.includes(column.field)) {
              let cellContent = "";

              // Format cell content based on column type
              if (column.field === "finalStatus") {
                const statusClass =
                  item.finalStatus === "Approved"
                    ? "badge-success"
                    : item.finalStatus === "Rejected"
                    ? "badge-danger"
                    : "badge-warning";
                cellContent = `<span class="badge ${statusClass}">${
                  item[column.field] || ""
                }</span>`;
              } else {
                cellContent =
                  item[column.field] !== undefined ? item[column.field] : "";
              }

              row.append(
                `<td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900">${cellContent}</td>`
              );
            }
          });

          tbody.append(row);
        });
      } else {
        tbody.append(
          '<tr><td colspan="100%" class="px-3 py-4 text-center text-gray-500">No data available</td></tr>'
        );
      }
    }

    function updatePaginationControls(start, end, total) {
      // Update pagination info text
      if (total > 0) {
        $("#pagination-info").text(
          `Showing ${start} to ${end} of ${total} entries`
        );
      } else {
        $("#pagination-info").text("Showing 0 to 0 of 0 entries");
      }

      // Update total pages
      $("#total-pages").text(totalPages);

      // Update current page input
      $("#current-page").val(currentPage);

      // Enable/disable previous button
      if (currentPage <= 1) {
        $("#prev-page").prop("disabled", true);
      } else {
        $("#prev-page").prop("disabled", false);
      }

      // Enable/disable next button
      if (currentPage >= totalPages) {
        $("#next-page").prop("disabled", true);
      } else {
        $("#next-page").prop("disabled", false);
      }
    }

    function fetchFilterOptions() {
      $.ajax({
        url: "/production_overview/filter_options",
        method: "GET",
        success: function (response) {
          productOptions = response.products || [];
          statusOptions = response.statuses || [];

          // Populate product dropdowns
          const productSelects = $("#analysis-product, #table-product");
          productSelects.empty();
          productSelects.append('<option value="">All Products</option>');

          productOptions.forEach((product) => {
            productSelects.append(
              `<option value="${product}">${product}</option>`
            );
          });

          // Populate status dropdown
          const statusSelect = $("#table-status");
          statusSelect.empty();
          statusSelect.append('<option value="">All Statuses</option>');

          statusOptions.forEach((status) => {
            statusSelect.append(`<option value="${status}">${status}</option>`);
          });
        },
        error: function (xhr, status, error) {
          console.error("Error loading filter options:", error);
        },
      });
    }

    function setupEventHandlers() {
      // Chart refresh buttons
      $(".refresh-chart").on("click", function () {
        const chartId = $(this).data("chart");

        if (chartId === "daily-coil") {
          loadChart(
            "daily-coil",
            "/production_overview/daily_production_chart"
          );
        } else if (chartId === "coil-distribution") {
          loadChart(
            "coil-distribution",
            "/production_overview/coil_distribution_chart"
          );
        } else if (chartId === "coil-analysis") {
          loadAnalysisData();
        }
      });

      // Chart expand buttons
      $(".expand-chart").on("click", function () {
        const chartId = $(this).data("chart");
        const chartTitle = $(this)
          .closest(".chart-card")
          .find(".chart-card-title")
          .text();
        const chartHtml = $(`#${chartId}-chart`).html();

        $("#expanded-chart-title").text(chartTitle);
        $("#expanded-chart-container").html(chartHtml);
        $("#expanded-chart-modal").show();
      });

      // Close expanded chart
      $("#close-expanded-chart").on("click", function () {
        $("#expanded-chart-modal").hide();
      });

      // Analysis filters
      $("#apply-analysis-filters").on("click", function () {
        loadAnalysisData();
      });

      // Reset analysis filters
      $("#reset-analysis-filters").on("click", function () {
        $("#analysis-from-date").val("");
        $("#analysis-to-date").val("");
        $("#analysis-product").val("");

        // Reset the chart to default state
        $("#coil-analysis-chart").html(
          '<div class="flex h-full items-center justify-center text-gray-500">Please apply filters to view the analysis chart.</div>'
        );
      });

      // 3D visualization update
      $("#update-3d-visualization").on("click", function () {
        update3DVisualization();
      });

      // Table filters
      $("#apply-table-filters").on("click", function () {
        currentPage = 1;
        loadTableData();
      });

      // Reset table filters
      $("#reset-table-filters").on("click", function () {
        $("#table-serial-no").val("");
        $("#table-from-date").val("");
        $("#table-to-date").val("");
        $("#table-product").val("");
        $("#table-status").val("");
        currentPage = 1;
        loadTableData();
      });

      // Sort buttons

      // Clear sorting

      // Pagination handlers
      $("#items-per-page").on("change", function () {
        itemsPerPage = parseInt($(this).val());
        currentPage = 1; // Reset to first page when changing items per page
        loadTableData();
      });

      $("#prev-page").on("click", function () {
        if (currentPage > 1) {
          currentPage--;
          loadTableData();
        }
      });

      $("#next-page").on("click", function () {
        if (currentPage < totalPages) {
          currentPage++;
          loadTableData();
        }
      });

      $("#current-page").on("change", function () {
        const newPage = parseInt($(this).val());
        if (newPage >= 1 && newPage <= totalPages) {
          currentPage = newPage;
          loadTableData();
        } else {
          $(this).val(currentPage); // Reset to valid value
        }
      });

      // Export buttons
      $("#export-analysis-data").on("click", function () {
        exportData("analysis");
      });

      $("#export-3d-visualization").on("click", function () {
        exportData("3d");
      });

      $("#export-table-data").on("click", function () {
        exportData("table");
      });

      // Column selector button
      $("#column-selector-btn").on("click", function (e) {
        e.stopPropagation(); // Prevent immediate closing
        $("#column-dropdown").toggleClass("hidden");
      });

      // Close dropdown when clicking outside
      $(document).on("click", function (e) {
        if (
          !$(e.target).closest("#column-selector-btn, #column-dropdown").length
        ) {
          $("#column-dropdown").addClass("hidden");
        }
      });

      // Select all columns
      $("#select-all-columns").on("click", function () {
        allColumns.forEach((column) => {
          if (!visibleColumns.includes(column.field)) {
            visibleColumns.push(column.field);
          }
        });
        generateColumnToggles();
        generateTableHeader();
        updateTableWithData(tableData);
      });

      // Deselect all columns
      $("#deselect-all-columns").on("click", function () {
        visibleColumns = [];
        generateColumnToggles();
        generateTableHeader();
        updateTableWithData(tableData);
      });
    }

    function exportData(type) {
      let url = "/export_data?type=" + type;

      if (type === "analysis") {
        const fromDate = $("#analysis-from-date").val();
        const toDate = $("#analysis-to-date").val();
        const product = $("#analysis-product").val();

        if (fromDate) url += `&from_date=${fromDate}`;
        if (toDate) url += `&to_date=${toDate}`;
        if (product) url += `&product=${product}`;
      } else if (type === "3d") {
        const xAxis = $("#x-axis").val();
        const yAxis = $("#y-axis").val();
        const zAxis = $("#z-axis").val();
        const colorBy = $("#color-by").val();
        const visualizationType = $("#visualization-type").val();
        const fromDate = $("#viz-from-date").val();
        const toDate = $("#viz-to-date").val();

        url += `&x_axis=${xAxis}&y_axis=${yAxis}&z_axis=${zAxis}&color_by=${colorBy}&visualization_type=${visualizationType}`;

        if (fromDate) url += `&from_date=${fromDate}`;
        if (toDate) url += `&to_date=${toDate}`;
      } else if (type === "table") {
        const serialNo = $("#table-serial-no").val();
        const fromDate = $("#table-from-date").val();
        const toDate = $("#table-to-date").val();
        const product = $("#table-product").val();
        const status = $("#table-status").val();

        if (serialNo) url += `&serial_no=${serialNo}`;
        if (fromDate) url += `&from_date=${fromDate}`;
        if (toDate) url += `&to_date=${toDate}`;
        if (product) url += `&product=${product}`;
        if (status) url += `&status=${status}`;

        // Only add sorting parameters if sorting has been explicitly applied
        if (sortingApplied) {
          url += `&sort_by=${currentSortParam}&sort_direction=${currentSortDirection}`;
        }
      }

      window.location.href = url;
    }
  });
</script>
{% endblock %}
